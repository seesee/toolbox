<!doctype html><html lang="en-GB"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="favicon.ico" type="image/x-icon"><title>Activity Tracker</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);min-height:100vh;color:#333}.container{max-width:1200px;margin:0 auto;padding:20px}.header{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 8px 32px rgba(0,0,0,.1)}.nav{display:flex;gap:15px;margin-top:15px}.nav-btn{padding:10px 20px;border:none;background:#667eea;color:#fff;border-radius:8px;cursor:pointer;font-weight:500}.nav-btn:hover{background:#5a67d8;transform:translateY(-2px)}.nav-btn.active{background:#4c51bf;box-shadow:0 4px 15px rgba(76,81,191,.4)}.section{display:none;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:15px;padding:30px;box-shadow:0 8px 32px rgba(0,0,0,.1)}.section.active{display:block}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:600;color:#4a5568}.form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:16px;transition:border-color .3s}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:0;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}.form-group-buttons{margin-top:32px}.btn{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:16px;transition:.3s;margin-right:10px;margin-bottom:10px}.btn-primary{background:#667eea;color:#fff}.btn-primary:hover{background:#5a67d8;transform:translateY(-2px)}.btn-secondary{background:#718096;color:#fff}.btn-secondary:hover{background:#4a5568}.btn-danger{background:#e53e3e;color:#fff}.btn-danger:hover{background:#c53030}.btn-success{background:#38a169;color:#fff}.btn-success:hover{background:#2f855a}.entries-list{margin-top:30px}.entry-item{background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:20px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:flex-start}.entry-content{flex:1}.entry-time{font-weight:600;color:#667eea;margin-bottom:5px}.entry-activity{font-size:18px;margin-bottom:5px}.entry-description{color:#718096;font-size:14px}.entry-description .md-paragraph{margin:5px 0}.entry-description .md-list{margin:5px 0;padding-left:20px}.entry-description .md-blockquote{margin:8px 0;padding:5px 10px;font-size:13px}.entry-description .md-code{font-size:12px}.entry-actions{display:flex;gap:10px}.settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:30px}.settings-section{background:#f7fafc;padding:20px;border-radius:8px;border:1px solid #e2e8f0}.settings-section h3{margin-bottom:15px;color:#2d3748}.checkbox-group{display:flex;align-items:center;margin-bottom:10px}.checkbox-group input[type=checkbox]{width:auto;margin-right:10px}.notification-status{padding:10px;border-radius:8px;margin-bottom:20px;text-align:center;font-weight:600}.notification-enabled{background:#c6f6d5;color:#22543d}.notification-disabled{background:#fed7d7;color:#742a2a}.notification-warning{background:#fef5e7;color:#744210}.report-filters{background:#f7fafc;padding:20px;border-radius:8px;margin-bottom:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;align-items:end}.report-summary{background:#e6fffa;padding:20px;border-radius:8px;margin-bottom:20px;border-left:4px solid #38b2ac}.report-navigation{display:flex;gap:10px;align-items:center;margin-bottom:20px}.week-display{background:#f7fafc;padding:10px 15px;border-radius:8px;font-weight:600;min-width:200px;text-align:center}.download-section{background:#f0fff4;padding:20px;border-radius:8px;margin-top:20px;border-left:4px solid #38a169}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000}.modal.active{display:flex;align-items:center;justify-content:center}.modal-content{background:#fff;padding:30px;border-radius:15px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}.status-indicator{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px}.status-active{background:#48bb78}.status-inactive{background:#f56565}.backup-buttons,.notification-buttons{display:flex;gap:10px;flex-wrap:wrap}.debug-info{background:#f7fafc;padding:15px;border-radius:8px;margin-top:15px;font-family:monospace;font-size:14px;border-left:4px solid #667eea}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}.markdown-preview{background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:20px;margin:15px 0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.6}.markdown-preview .md-h1{color:#2d3748;border-bottom:2px solid #667eea;padding-bottom:10px;margin:20px 0 15px}.markdown-preview .md-h2{color:#2d3748;border-bottom:1px solid #e2e8f0;padding-bottom:5px;margin:18px 0 12px}.markdown-preview .md-h3{color:#4a5568;margin:15px 0 10px}.markdown-preview .md-blockquote{border-left:4px solid #667eea;margin:15px 0;color:#718096;font-style:italic;background:rgba(102,126,234,.05);padding:10px 15px;border-radius:0 4px 4px 0}.markdown-preview .md-code{background:#edf2f7;padding:2px 6px;border-radius:4px;font-family:Monaco,Consolas,monospace;font-size:14px}.markdown-preview .md-list{margin:10px 0;padding-left:30px}.markdown-preview .md-paragraph{margin:10px 0}.markdown-preview .md-hr{border:none;border-top:1px solid #e2e8f0;margin:20px 0}.markdown-preview .md-preview-more{color:#718096;font-style:italic;text-align:center;margin:15px 0 5px}.md-paragraph{margin:8px 0}.md-paragraph:first-child{margin-top:0}.md-paragraph:last-child{margin-bottom:0}.md-list{margin:8px 0}.md-list li{margin:3px 0}.md-blockquote{margin:8px 0}.report-format-tabs{display:flex;margin-bottom:15px;border-bottom:1px solid #e2e8f0}.format-tab{padding:10px 20px;border:none;background:0 0;cursor:pointer;font-weight:600;color:#718096;border-bottom:2px solid transparent;transition:.3s}.format-tab:hover{color:#4a5568}.format-tab.active{color:#667eea;border-bottom-color:#667eea}.report-preview-container{margin-top:20px;background:#f7fafc;border-radius:8px;padding:20px;border:1px solid #e2e8f0}.report-preview-content{margin-top:10px;background:#fff;padding:15px;border-radius:5px;border:1px solid #e2e8f0;max-height:500px;overflow-y:auto;white-space:pre-wrap;font-family:monospace}.dark-mode .report-preview-container{background:#2d3748;border-color:#4a5568}.dark-mode .report-preview-content{background:#1a202c;border-color:#4a5568;color:#e2e8f0}.nav-btn{transition:.3s,background 1s ease-out}#pauseButton{min-width:180px;text-align:center}@media (max-width:768px){.container{padding:10px}.nav{flex-wrap:wrap}.entry-item{flex-direction:column;gap:15px}.entry-actions{align-self:flex-end}.report-navigation{flex-wrap:wrap}.week-display{min-width:150px}}body.dark-mode{background:linear-gradient(135deg,#2d3748 0,#1a202c 100%);color:#e2e8f0}.dark-mode .header,.dark-mode .section{background:rgba(45,55,72,.85);backdrop-filter:blur(10px);color:#e2e8f0}.dark-mode .form-group label{color:#a0aec0}.dark-mode .form-group input,.dark-mode .form-group select,.dark-mode .form-group textarea{background:#2d3748;border-color:#4a5568;color:#e2e8f0}.dark-mode .form-group input:focus,.dark-mode .form-group select:focus,.dark-mode .form-group textarea:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.2)}.dark-mode .entry-item{background:#2d3748;border-color:#4a5568}.dark-mode .entry-description{color:#a0aec0}.dark-mode .settings-section{background:#1a202c;border-color:#4a5568}.dark-mode .settings-section h3{color:#e2e8f0}.dark-mode .report-filters{background:#2d3748}.dark-mode .week-display{background:#2d3748;color:#e2e8f0}.dark-mode .report-summary{background:#2c5282;color:#bee3f8;border-left-color:#63b3ed}.dark-mode .download-section{background:#2f855a;color:#c6f6d5;border-left-color:#68d391}.dark-mode .modal-content{background:#2d3748}.dark-mode .debug-info{background:#1a202c;border-left-color:#667eea}.dark-mode .markdown-preview{background:#1a202c;border-color:#4a5568}.dark-mode .markdown-preview .md-h1,.dark-mode .markdown-preview .md-h2,.dark-mode .markdown-preview .md-h3{color:#e2e8f0}.dark-mode .markdown-preview .md-blockquote{color:#a0aec0;background:rgba(102,126,234,.1);border-left-color:#667eea}.dark-mode .markdown-preview .md-code{background:#2d3748;color:#e2e8f0}.dark-mode .format-tab{color:#a0aec0}.dark-mode .format-tab:hover{color:#e2e8f0}.dark-mode .format-tab.active{color:#667eea;border-bottom-color:#667eea}#report-templates-editor .template-group{margin-bottom:15px}#report-templates-editor label{font-weight:700;display:block;margin-bottom:5px}#report-templates-editor textarea{width:100%;min-height:150px;font-family:monospace;font-size:14px;padding:10px;border-radius:5px;border:1px solid #e2e8f0}.dark-mode #report-templates-editor textarea{background:#1a202c;border-color:#4a5568;color:#e2e8f0}</style></head><body><div class="container"><div class="header"><h1>Activity Tracker</h1><p>Track your daily activities with automatic reminders</p><div class="nav"><button class="nav-btn active" onclick="showSection('tracker', event)">Tracker</button> <button class="nav-btn" onclick="showSection('reports', event)">Reports</button> <button class="nav-btn" onclick="showSection('settings', event)">Settings</button> <button id="pauseButton" class="nav-btn" onclick="togglePause()">Pause Alerts</button></div></div><div id="tracker" class="section active"><h2>Activity Entry</h2><form id="activityForm"><div class="form-group"><label for="activity">What are you doing?</label> <input id="activity" required placeholder="e.g., Writing report, Meeting with team" autocomplete="off"></div><div class="form-group"><label for="description">Description (optional)</label> <textarea id="description" rows="3" placeholder="Additional details about this activity"></textarea></div><div class="form-group"><label for="timestamp">Time</label> <input type="datetime-local" id="timestamp" required></div><button type="submit" class="btn btn-primary">Add Entry</button> <button type="button" class="btn btn-secondary" onclick="addCurrentTime()">Use Current Time</button></form><div class="entries-list"><h3>Recent Entries</h3><div id="entriesList"></div></div></div><div id="reports" class="section"><h2>Activity Reports</h2><div class="report-navigation"><button class="btn btn-secondary" onclick="previousWeek()">← Previous Week</button><div class="week-display" id="weekDisplay">Week of ...</div><button class="btn btn-secondary" onclick="nextWeek()">Next Week →</button></div><div class="report-filters"><div class="form-group"><label for="reportStartDate">Start Date</label> <input type="date" id="reportStartDate"></div><div class="form-group"><label for="reportEndDate">End Date</label> <input type="date" id="reportEndDate"></div><div class="form-group form-group-buttons"><button class="btn btn-primary" onclick="generateReport()">Generate Report</button> <button class="btn btn-secondary" onclick="setWeeklyReport()">This Week</button></div></div><div class="download-section"><h3>Download Report</h3><p>Select a template and download the current report.</p><div style="margin-top:15px"><div class="form-group" style="display:inline-block;width:250px;margin-right:15px"><label for="reportTemplate">Report Template</label> <select id="reportTemplate" onchange="tracker.previewReport()"></select></div><button class="btn btn-success" onclick="downloadReport()">Download Report</button></div></div><div id="reportPreviewContainer" class="report-preview-container"><h3>Report Preview</h3><div id="reportPreview" class="report-preview-content">Select a date range and generate a report to see a preview.</div></div></div><div id="settings" class="section"><h2>Settings</h2><div class="notification-status" id="notificationStatus"><span class="status-indicator" id="statusIndicator"></span> <span id="statusText">Checking notification status...</span></div><div class="settings-grid"><div class="settings-section"><h3>Notification Settings</h3><div class="notification-buttons"><button class="btn btn-primary" onclick="enableNotifications()">Enable Notifications</button> <button class="btn btn-secondary" onclick="testNotification()">Test Notification</button> <button class="btn btn-secondary" onclick="refreshNotificationStatus()">Refresh Status</button> <button class="btn btn-secondary" onclick="testNotificationSound()">Test Sound</button> <button class="btn btn-secondary" onclick="runServiceWorkerTest()">Test Service Worker</button></div><div class="form-group"><label for="notificationInterval">Reminder Interval (minutes)</label> <select id="notificationInterval"><option value="1">1 minute</option><option value="2">2 minutes</option><option value="5">5 minutes</option><option value="15">15 minutes</option><option value="30">30 minutes</option><option value="60" selected="selected">1 hour</option><option value="90">1.5 hours</option><option value="120">2 hours</option></select></div><div class="form-group"><label for="pauseDuration">Auto-resume alerts after</label> <select id="pauseDuration"><option value="15">15 minutes</option><option value="60">1 hour</option><option value="240">4 hours</option><option value="1440">24 hours</option><option value="-1">Never</option></select></div><div class="form-group"><label for="notificationSoundType">Notification Sound</label> <select id="notificationSoundType"><option value="classic">Classic Bloop</option><option value="gentle">Gentle Chime</option><option value="urgent">Urgent Ping</option><option value="digital">Digital Beep</option><option value="nature">Nature Drop</option><option value="mechanical">Mechanical Click</option><option value="spacey">Spacey Wobble</option><option value="corporate">Corporate Ding</option></select></div><div class="checkbox-group"><input type="checkbox" id="muteNotificationSound"> <label for="muteNotificationSound">Mute notification sound</label></div><div class="debug-info" id="debugInfo"><strong>About:</strong><br><span id="debugText">Loading...</span></div></div><div class="settings-section"><h3>Working Hours</h3><div class="form-group"><label for="startTime">Start Time</label> <input type="time" id="startTime" value="08:00"></div><div class="form-group"><label for="endTime">End Time</label> <input type="time" id="endTime" value="18:00"></div></div><div class="settings-section"><h3>Working Days</h3><div class="checkbox-group"><input type="checkbox" id="monday" checked="checked"> <label for="monday">Monday</label></div><div class="checkbox-group"><input type="checkbox" id="tuesday" checked="checked"> <label for="tuesday">Tuesday</label></div><div class="checkbox-group"><input type="checkbox" id="wednesday" checked="checked"> <label for="wednesday">Wednesday</label></div><div class="checkbox-group"><input type="checkbox" id="thursday" checked="checked"> <label for="thursday">Thursday</label></div><div class="checkbox-group"><input type="checkbox" id="friday" checked="checked"> <label for="friday">Friday</label></div><div class="checkbox-group"><input type="checkbox" id="saturday"> <label for="saturday">Saturday</label></div><div class="checkbox-group"><input type="checkbox" id="sunday"> <label for="sunday">Sunday</label></div></div><div class="settings-section"><h3>Appearance</h3><div class="checkbox-group"><input type="checkbox" id="darkMode"> <label for="darkMode">Enable Dark Mode</label></div></div><div class="settings-section"><h3>Report Templates</h3><p>Customise the templates used for report generation. Use placeholders like <code>{{DATE}}</code>, <code>{{SUMMARY}}</code>, and <code>{{ENTRIES}}</code>.</p><div id="report-templates-editor"></div><button class="btn btn-primary" onclick="saveReportTemplates()">Save Templates</button> <button class="btn btn-secondary" onclick="resetReportTemplates()">Reset to Default</button></div><div class="settings-section"><h3>Database Backup</h3><p>Export your activity data as a backup file, or import from a previous backup.</p><div class="backup-buttons"><button class="btn btn-primary" onclick="exportDatabase()">Export Database</button> <button class="btn btn-secondary" onclick="importDatabase()">Import Database</button> <input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImportFile(event)"></div></div></div><button class="btn btn-primary" onclick="saveSettings()">Save Settings</button> <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button></div></div><div id="editModal" class="modal"><div class="modal-content"><h3>Edit Entry</h3><form id="editForm"><input type="hidden" id="editId"><div class="form-group"><label for="editActivity">Activity</label> <input id="editActivity" required></div><div class="form-group"><label for="editDescription">Description</label> <textarea id="editDescription" rows="3"></textarea></div><div class="form-group"><label for="editTimestamp">Time</label> <input type="datetime-local" id="editTimestamp" required></div><button type="submit" class="btn btn-primary">Update Entry</button> <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button></form></div></div><script>const APP_VERSION="2025.07.31.06";function formatDateTime(t){return new Date(t).toLocaleString("en-GB",{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function formatDate(t){return t.toLocaleDateString("en-GB",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}function formatTime(t){return new Date(t).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})}function escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}function showNotification(t,e="info",i=3e3){const n=document.createElement("div");n.style.cssText=`\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        padding: 15px 20px;\n        border-radius: 8px;\n        color: white;\n        font-weight: 600;\n        z-index: 10000;\n        background: ${"success"===e?"#48bb78":"error"===e?"#f56565":"#667eea"};\n        box-shadow: 0 4px 15px rgba(0,0,0,0.2);\n        animation: slideIn 0.3s ease-out;\n    `;const a=document.createElement("style");a.textContent="\n        @keyframes slideIn {\n            from {\n                transform: translateX(100%);\n                opacity: 0;\n            }\n            to {\n                transform: translateX(0);\n                opacity: 1;\n            }\n        }\n        @keyframes slideOut {\n            from {\n                transform: translateX(0);\n                opacity: 1;\n            }\n            to {\n                transform: translateX(100%);\n                opacity: 0;\n            }\n        }\n    ",document.head.appendChild(a),n.textContent=t,document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideOut 0.3s ease-in",setTimeout(()=>{n.parentNode&&n.remove()},300)},i)}function downloadFile(t,e,i){const n=new Blob([t],{type:i}),a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}function getCurrentTimeForInput(){const t=new Date;return t.setMinutes(t.getMinutes()-t.getTimezoneOffset()),t.toISOString().slice(0,16)}function escapeCsv(t){return t?t.includes(",")||t.includes('"')||t.includes("\n")?`"${t.replace(/"/g,'""')}"`:t:""}function generateId(){return Date.now().toString()+Math.random().toString(36).substr(2,9)}function isValidDate(t){const e=new Date(t);return e instanceof Date&&!isNaN(e)}function getWeekStart(t){const e=new Date(t),i=t.getDay(),n=0===i?-6:1-i;return e.setDate(t.getDate()+n),e.setHours(0,0,0,0),e}function getWeekEnd(t){const e=new Date(getWeekStart(t));return e.setDate(e.getDate()+6),e.setHours(23,59,59,999),e}function deepClone(t){if(null===t||"object"!=typeof t)return t;if(t instanceof Date)return new Date(t.getTime());if(t instanceof Array)return t.map(t=>deepClone(t));if("object"==typeof t){const e={};return Object.keys(t).forEach(i=>{e[i]=deepClone(t[i])}),e}}class SoundManager{constructor(){this.audioContext=null,this.soundTypes={classic:"Classic Bloop",gentle:"Gentle Chime",urgent:"Urgent Ping",digital:"Digital Beep",nature:"Nature Drop",mechanical:"Mechanical Click",spacey:"Spacey Wobble",corporate:"Corporate Ding"},this.initAudioContext()}initAudioContext(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(t){console.warn("Web Audio API not supported:",t),this.audioContext=null}}getSoundTypes(){return this.soundTypes}playSound(t="classic",e=!1){if(this.audioContext&&!e)try{"suspended"===this.audioContext.state&&this.audioContext.resume();const e=this.audioContext.currentTime;switch(t){case"classic":default:this.playClassicBloop(e);break;case"gentle":this.playGentleChime(e);break;case"urgent":this.playUrgentPing(e);break;case"digital":this.playDigitalBeep(e);break;case"nature":this.playNatureDrop(e);break;case"mechanical":this.playMechanicalClick(e);break;case"spacey":this.playSpaceyWobble(e);break;case"corporate":this.playCorporateDing(e)}}catch(t){console.warn("Error playing notification sound:",t)}}playClassicBloop(t){const e=this.audioContext.createOscillator(),i=this.audioContext.createGain();e.connect(i),i.connect(this.audioContext.destination),e.type="sine",e.frequency.setValueAtTime(400,t),e.frequency.exponentialRampToValueAtTime(600,t+.1),i.gain.setValueAtTime(0,t),i.gain.linearRampToValueAtTime(.3,t+.05),i.gain.exponentialRampToValueAtTime(.01,t+.3),e.start(t),e.stop(t+.3)}playGentleChime(t){const e=this.audioContext.createOscillator(),i=this.audioContext.createOscillator(),n=this.audioContext.createGain();e.connect(n),i.connect(n),n.connect(this.audioContext.destination),e.type="sine",i.type="sine",e.frequency.setValueAtTime(523.25,t),i.frequency.setValueAtTime(659.25,t),n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(.2,t+.05),n.gain.exponentialRampToValueAtTime(.01,t+1),e.start(t),i.start(t),e.stop(t+1),i.stop(t+1)}playUrgentPing(t){const e=this.audioContext.createOscillator(),i=this.audioContext.createGain();e.connect(i),i.connect(this.audioContext.destination),e.type="triangle",e.frequency.setValueAtTime(800,t),e.frequency.exponentialRampToValueAtTime(1200,t+.05),e.frequency.exponentialRampToValueAtTime(800,t+.1),i.gain.setValueAtTime(0,t),i.gain.linearRampToValueAtTime(.4,t+.02),i.gain.exponentialRampToValueAtTime(.01,t+.15),e.start(t),e.stop(t+.15)}playDigitalBeep(t){const e=this.audioContext.createOscillator(),i=this.audioContext.createGain();e.connect(i),i.connect(this.audioContext.destination),e.type="square",e.frequency.setValueAtTime(1e3,t),i.gain.setValueAtTime(0,t),i.gain.linearRampToValueAtTime(.3,t+.01),i.gain.linearRampToValueAtTime(.3,t+.05),i.gain.linearRampToValueAtTime(0,t+.06),e.start(t),e.stop(t+.06)}playNatureDrop(t){const e=this.audioContext.createOscillator(),i=this.audioContext.createGain(),n=this.audioContext.createBiquadFilter();e.connect(n),n.connect(i),i.connect(this.audioContext.destination),e.type="sine",e.frequency.setValueAtTime(1200,t),e.frequency.exponentialRampToValueAtTime(200,t+.8),n.type="lowpass",n.frequency.setValueAtTime(2e3,t),n.frequency.exponentialRampToValueAtTime(300,t+.8),i.gain.setValueAtTime(0,t),i.gain.linearRampToValueAtTime(.25,t+.05),i.gain.exponentialRampToValueAtTime(.01,t+.8),e.start(t),e.stop(t+.8)}playMechanicalClick(t){const e=this.audioContext.createOscillator(),i=this.audioContext.createGain(),n=this.audioContext.createBiquadFilter();e.connect(n),n.connect(i),i.connect(this.audioContext.destination),e.type="sawtooth",e.frequency.setValueAtTime(150,t),n.type="highpass",n.frequency.setValueAtTime(100,t),i.gain.setValueAtTime(0,t),i.gain.linearRampToValueAtTime(.5,t+.005),i.gain.linearRampToValueAtTime(0,t+.05),e.start(t),e.stop(t+.05)}playSpaceyWobble(t){const e=this.audioContext.createOscillator(),i=this.audioContext.createOscillator(),n=this.audioContext.createGain(),a=this.audioContext.createGain();i.connect(n),n.connect(e.frequency),e.connect(a),a.connect(this.audioContext.destination),e.type="sine",e.frequency.setValueAtTime(300,t),i.type="sine",i.frequency.setValueAtTime(6,t),n.gain.setValueAtTime(50,t),a.gain.setValueAtTime(0,t),a.gain.linearRampToValueAtTime(.3,t+.1),a.gain.exponentialRampToValueAtTime(.01,t+1.2),i.start(t),e.start(t),i.stop(t+1.2),e.stop(t+1.2)}playCorporateDing(t){const e=this.audioContext.createOscillator(),i=this.audioContext.createOscillator(),n=this.audioContext.createGain();e.connect(n),i.connect(n),n.connect(this.audioContext.destination),e.type="sine",i.type="sine",e.frequency.setValueAtTime(880,t),i.frequency.setValueAtTime(1108.73,t),n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(.25,t+.02),n.gain.exponentialRampToValueAtTime(.01,t+.5),e.start(t),i.start(t),e.stop(t+.5),i.stop(t+.5)}testSound(t,e=!1){this.playSound(t,e)}}"undefined"!=typeof window&&(window.SoundManager=SoundManager);class PauseManager{constructor(t){this.tracker=t,this.countdownInterval=null,this.pauseButton=null,this.originalButtonText="Pause Alerts",this.init()}init(){this.pauseButton=document.getElementById("pauseButton"),this.pauseButton&&this.updatePauseButtonDisplay()}startPause(t){this.stopCountdown(),-1===t?(this.tracker.settings.notificationsPausedUntil=1/0,this.updatePauseButtonForever()):(this.tracker.settings.notificationsPausedUntil=(new Date).getTime()+60*t*1e3,this.startCountdown()),this.tracker.saveSettings()}resume(){this.stopCountdown(),this.tracker.settings.notificationsPausedUntil=null,this.updatePauseButtonNormal(),this.tracker.saveSettings()}startCountdown(){this.countdownInterval&&clearInterval(this.countdownInterval),this.updateCountdownDisplay(),this.countdownInterval=setInterval(()=>{this.updateCountdownDisplay()},1e3)}stopCountdown(){this.countdownInterval&&(clearInterval(this.countdownInterval),this.countdownInterval=null)}updateCountdownDisplay(){if(!this.pauseButton||!this.tracker.settings.notificationsPausedUntil)return void this.updatePauseButtonNormal();const t=(new Date).getTime(),e=this.tracker.settings.notificationsPausedUntil;if(e===1/0)return void this.updatePauseButtonForever();const i=e-t;if(i<=0)return this.resume(),void showNotification("Notifications automatically resumed","success");const n=Math.floor(i/1e3),a=Math.floor(n/3600),o=Math.floor(n%3600/60),r=n%60;let s;s=a>0?`${a}h ${o}m ${r}s`:o>0?`${o}m ${r}s`:`${r}s`,this.pauseButton.textContent=`Resume (${s})`;const c=60*this.tracker.settings.pauseDuration*1e3,l=c-i,d=Math.max(0,Math.min(100,l/c*100));this.applyDrainingEffect(d)}applyDrainingEffect(t){const e="rgba(229, 62, 62, 0.3)",i="#e53e3e";this.pauseButton.style.background=`linear-gradient(to left, ${e} 0%, ${e} ${t}%, ${i} ${t}%, ${i} 100%)`,this.pauseButton.style.transition="background 1s ease-out",this.pauseButton.style.animation=t>90?"pulse 1s infinite":"none"}updatePauseButtonForever(){this.pauseButton.textContent="Resume (Paused Forever)",this.pauseButton.style.background="#e53e3e",this.pauseButton.style.animation="none",this.pauseButton.style.transition=""}updatePauseButtonNormal(){this.pauseButton.textContent=this.originalButtonText,this.pauseButton.style.background="",this.pauseButton.style.animation="none",this.pauseButton.style.transition=""}updatePauseButtonDisplay(){this.pauseButton&&(this.tracker.settings.notificationsPausedUntil?this.tracker.settings.notificationsPausedUntil===1/0?this.updatePauseButtonForever():this.startCountdown():this.updatePauseButtonNormal())}isPaused(){return!!this.tracker.settings.notificationsPausedUntil&&(this.tracker.settings.notificationsPausedUntil===1/0||(new Date).getTime()<this.tracker.settings.notificationsPausedUntil)}getRemainingTime(){if(!this.tracker.settings.notificationsPausedUntil)return 0;if(this.tracker.settings.notificationsPausedUntil===1/0)return-1;const t=(new Date).getTime(),e=this.tracker.settings.notificationsPausedUntil-t;return Math.max(0,e)}destroy(){this.stopCountdown()}}"undefined"!=typeof window&&(window.PauseManager=PauseManager);class MarkdownRenderer{constructor(){this.rules=[{pattern:/^### (.*$)/gim,replacement:"<h3>$1</h3>"},{pattern:/^## (.*$)/gim,replacement:"<h2>$1</h2>"},{pattern:/^# (.*$)/gim,replacement:"<h1>$1</h1>"},{pattern:/\*\*(.*)\*\*/gim,replacement:"<strong>$1</strong>"},{pattern:/\*(.*)\*/gim,replacement:"<em>$1</em>"},{pattern:/`(.*)`/gim,replacement:"<code>$1</code>"},{pattern:/\[([^\]]*)\]\(([^\)]*)\)/gim,replacement:'<a href="$2">$1</a>'},{pattern:/^---\s*$/gim,replacement:"<hr>"},{pattern:/^> (.*)$/gim,replacement:"<blockquote>$1</blockquote>"},{pattern:/^\- (.*)$/gim,replacement:"<li>$1</li>"}]}render(t,e=!1){if(!t||"string"!=typeof t)return"";let i=t.trim();return this.rules.forEach(t=>{i=i.replace(t.pattern,t.replacement)}),i=i.replace(/\n\s*\n/gim,"</p><p>"),i=i.replace(/\n(?![<\/])/gim,"<br>"),e&&i.match(/^<(h[1-6]|ul|ol|blockquote|hr)/)||(i="<p>"+i+"</p>"),i=i.replace(/<p>\s*<\/p>/gim,""),i=i.replace(/<p><h/gim,"<h"),i=i.replace(/<\/h([1-6])><\/p>/gim,"</h$1>"),i=i.replace(/<p><hr><\/p>/gim,"<hr>"),i=i.replace(/<p><blockquote>/gim,"<blockquote>"),i=i.replace(/<\/blockquote><\/p>/gim,"</blockquote>"),i=i.replace(/<p><ul>/gim,"<ul>"),i=i.replace(/<\/ul><\/p>/gim,"</ul>"),i=this.renderLists(i),i=i.replace(/<br>\s*<\/li>/gim,"</li>"),i=i.replace(/<li><br>/gim,"<li>"),i=i.replace(/<\/ul><br>/gim,"</ul>"),i=i.replace(/<br><ul>/gim,"<ul>"),i}renderLists(t){return(t=(t=(t=(t=(t=(t=t.replace(/(<li>.*?<\/li>)(\s*(<br>)?\s*<li>.*?<\/li>)*/gim,t=>(t.replace(/<br>\s*(?=<li>)/gim,""),"<ul>"+t+"</ul>"))).replace(/<p><ul>/gim,"<ul>")).replace(/<\/ul><\/p>/gim,"</ul>")).replace(/<p><li>/gim,"<li>")).replace(/<\/li><\/p>/gim,"</li>")).replace(/<br>\s*<ul>/gim,"<ul>")).replace(/<\/ul>\s*<br>/gim,"</ul>")}renderInline(t){return this.render(t,!0)}renderWithClasses(t,e=!1){let i=this.render(t,e);return i=i.replace(/<h1>/gim,'<h1 class="md-h1">'),i=i.replace(/<h2>/gim,'<h2 class="md-h2">'),i=i.replace(/<h3>/gim,'<h3 class="md-h3">'),i=i.replace(/<blockquote>/gim,'<blockquote class="md-blockquote">'),i=i.replace(/<code>/gim,'<code class="md-code">'),i=i.replace(/<ul>/gim,'<ul class="md-list">'),i=i.replace(/<p>/gim,'<p class="md-paragraph">'),i=i.replace(/<hr>/gim,'<hr class="md-hr">'),i}renderInlineWithClasses(t){return this.renderWithClasses(t,!0)}preview(t,e=10){if(!t)return"";const i=t.split("\n").slice(0,e),n=i.join("\n");return i.length>=e&&t.split("\n").length>e?this.renderWithClasses(n)+'<p class="md-preview-more">...</p>':this.renderWithClasses(n)}}"undefined"!=typeof window&&(window.MarkdownRenderer=MarkdownRenderer);class TemplatingEngine{constructor(){this.formatters={date:(t,e="dd/mm/yyyy")=>this.formatDate(t,e),time:t=>{if(!t)return"--:--";let e=t instanceof Date?t:new Date(t);return isNaN(e.getTime())?"--:--":e.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})},datetime:t=>new Date(t).toLocaleString("en-GB"),uppercase:t=>String(t).toUpperCase(),lowercase:t=>String(t).toLowerCase(),capitalize:t=>String(t).charAt(0).toUpperCase()+String(t).slice(1),escapeHtml:t=>this.escapeHtml(t),escapeCsv:t=>this.escapeCsv(t),nl2br:t=>String(t).replace(/\n/g,"<br>"),stripLinebreaks:t=>String(t).replace(/(\r\n|\n|\r)/gm," "),duration:t=>this.formatDuration(t),markdown:t=>window.MarkdownRenderer?(new window.MarkdownRenderer).renderInlineWithClasses(String(t)):this.escapeHtml(t)}}render(t,e){try{const i=this.tokenize(t),n=this.parse(i);return this.evaluate(n,e)}catch(t){return console.error("❌ Template render error:",t),`Template Error: ${t.message}`}}tokenize(t){const e=[];let i=0;for(;i<t.length;){const n=t.indexOf("{{",i);if(-1===n){i<t.length&&e.push({type:"TEXT",value:t.substring(i)});break}n>i&&e.push({type:"TEXT",value:t.substring(i,n)});const a=t.indexOf("}}",n);if(-1===a)throw new Error("Unclosed template expression at position "+n);const o=t.substring(n+2,a).trim(),r=this.parseExpression(o);e.push(r),i=a+2}return e}parseExpression(t){if(t.startsWith("#each ")){const e=t.match(/^#each\s+(\w+)\s*=\s*([\w.]+)$/);if(!e)throw new Error("Invalid each expression: "+t);return{type:"EACH_START",itemVar:e[1],arrayPath:e[2]}}if("/each"===t)return{type:"EACH_END"};if(t.startsWith("#if "))return{type:"IF_START",condition:t.substring(4).trim()};if("else"===t)return{type:"ELSE"};if("/if"===t)return{type:"IF_END"};const e=t.split("|").map(t=>t.trim());return{type:"VARIABLE",path:e[0],formatters:e.slice(1)}}parse(t){const e=[];let i=0;for(;i<t.length;){const n=this.parseNode(t,i);n?(e.push(n.node),i=n.nextIndex):i++}return e}parseNode(t,e){if(e>=t.length)return null;const i=t[e];switch(i.type){case"TEXT":return{node:{type:"text",value:i.value},nextIndex:e+1};case"VARIABLE":return{node:{type:"variable",path:i.path,formatters:i.formatters},nextIndex:e+1};case"EACH_START":return this.parseEachLoop(t,e);case"IF_START":return this.parseIfStatement(t,e);case"EACH_END":case"IF_END":case"ELSE":return console.warn("⚠️ Orphaned token:",i.type,"at index",e),null;default:throw new Error("Unknown token type: "+i.type)}}parseEachLoop(t,e){const i=t[e],n=[];let a=e+1,o=1;for(;a<t.length&&o>0;){const e=t[a];if("EACH_START"===e.type){const e=this.parseEachLoop(t,a);n.push(e.node),a=e.nextIndex}else if("EACH_END"===e.type){if(o--,0===o)break;console.error(`❌ Unexpected EACH_END at depth ${o} for ${i.itemVar}`),a++}else{const e=this.parseNode(t,a);e?(n.push(e.node),a=e.nextIndex):a++}}if(o>0)throw console.error(`❌ Unclosed each loop for ${i.itemVar}, depth: ${o}, current: ${a}, tokens.length: ${t.length}`),console.error("Remaining tokens:",t.slice(a).map(t=>`${t.type}: ${JSON.stringify(t.value||t.path)}`)),new Error(`Unclosed each loop for ${i.itemVar}`);return{node:{type:"each",itemVar:i.itemVar,arrayPath:i.arrayPath,children:n},nextIndex:a+1}}parseIfStatement(t,e){const i=t[e],n=[],a=[];let o=e+1,r=1,s=!1;for(;o<t.length&&r>0;){const e=t[o];if("IF_START"===e.type){r++;const e=this.parseIfStatement(t,o);s?a.push(e.node):n.push(e.node),o=e.nextIndex}else if("IF_END"===e.type){if(r--,0===r)break;o++}else if("ELSE"===e.type&&1===r)s=!0,o++;else{const e=this.parseNode(t,o);e?(s?a.push(e.node):n.push(e.node),o=e.nextIndex):o++}}return{node:{type:"if",condition:i.condition,ifChildren:n,elseChildren:a},nextIndex:o+1}}evaluate(t,e,i=0){return"  ".repeat(i),t.map(t=>this.evaluateNode(t,e,i)).join("")}evaluateNode(t,e,i=0){const n="  ".repeat(i);switch(t.type){case"text":return t.value;case"variable":let a=this.getValue(e,t.path);for(const e of t.formatters||[])a=this.applyFormatter(a,e);return null!=a?String(a):"";case"each":const o=this.getValue(e,t.arrayPath);return Array.isArray(o)?o.map((n,a)=>{const r={...e,[t.itemVar]:n,index:a,first:0===a,last:a===o.length-1};return this.evaluate(t.children,r,i+1)}).join(""):(console.warn(`${n}⚠️ Not an array:`,o),"");case"if":const r=this.getValue(e,t.condition),s=this.isTruthy(r)?t.ifChildren:t.elseChildren;return this.evaluate(s,e,i+1);default:throw new Error("Unknown node type: "+t.type)}}getValue(t,e){if(!e||!t)return;const i=e.split(".");let n=t;for(const t of i){if(null==n)return;n=n[t]}return n}isTruthy(t){return null!=t&&("boolean"==typeof t?t:"number"==typeof t?0!==t:"string"==typeof t||Array.isArray(t)?t.length>0:"object"==typeof t?Object.keys(t).length>0:!!t)}applyFormatter(t,e){const i=e.match(/^(\w+)(?:\s*\(\s*['"]?(.*?)['"]?\s*\))?$/);if(!i)return t;const[,n,a]=i;if(!this.formatters[n])return console.warn("⚠️ Unknown formatter:",n),t;try{return void 0!==a?this.formatters[n](t,a):this.formatters[n](t)}catch(e){return console.warn("❌ Formatter error:",n,e),t}}formatDate(t,e){const i=new Date(t);if(isNaN(i.getTime()))return"Invalid Date";const n=i.getFullYear(),a=i.getMonth(),o=i.getDate();let r=e.replace(/mmm/g,["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a]);return r=r.replace(/yyyy/g,n).replace(/mm/g,String(a+1).padStart(2,"0")).replace(/dd/g,String(o).padStart(2,"0")),r}formatDuration(t){if(isNaN(t)||t<0)return"";const e=Math.floor(t/60),i=t%60;let n="";return e>0&&(n+=`${e}h `),i>0&&(n+=`${i}m`),n.trim()}escapeHtml(t){return null==t?"":String(t).replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]))}escapeCsv(t){if(null==t)return"";let e=String(t);return e.includes(",")||e.includes('"')||e.includes("\n")?`"${e.replace(/"/g,'""')}"`:e}}window.TemplatingEngine=TemplatingEngine,window.ReportTemplates={"detailed-html":{name:"Detailed Report (HTML)",description:"A comprehensive HTML report with timings and full descriptions.",type:"html",template:'<!DOCTYPE html>\n<html lang="en-GB">\n<head>\n    <meta charset="UTF-8">\n    <title>Activity Report: {{ report.startDate | date(\'dd/mm/yyyy\') }} - {{ report.endDate | date(\'dd/mm/yyyy\') }}</title>\n    <style>\n        body { font-family: sans-serif; line-height: 1.5; color: #333; }\n        .report-container { max-width: 800px; margin: 20px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }\n        .report-header { text-align: center; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 20px; }\n        .report-summary { background: #f0f2ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; }\n        .day-group { margin-bottom: 20px; }\n        .day-header { font-size: 1.2em; font-weight: bold; color: #667eea; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; }\n        .entry { margin-bottom: 10px; padding-left: 15px; border-left: 3px solid #ccc; }\n        .entry-time { font-weight: bold; }\n        .entry-activity { font-size: 1.1em; }\n        .entry-description { color: #555; font-style: italic; }\n        .duration { font-size: 0.9em; color: #888; }\n    </style>\n</head>\n<body>\n    <div class="report-container">\n        <div class="report-header">\n            <h1>Activity Report</h1>\n            <p>{{ report.startDate | date(\'dd mmm yyyy\') }} to {{ report.endDate | date(\'dd mmm yyyy\') }}</p>\n        </div>\n        <div class="report-summary">\n            <h3>Report Summary</h3>\n            <p><strong>Total Entries:</strong> {{ report.totalEntries }}</p>\n            <p><strong>Total Duration:</strong> {{ report.totalDuration | duration }}</p>\n            <p><strong>Active Days:</strong> {{ report.activeDays }}</p>\n        </div>\n        \n        {{#each day = days}}\n        <div class="day-group">\n            <h2 class="day-header">{{ day.date }} ({{ day.entries.length }} entries, {{ day.totalDuration | duration }})</h2>\n            {{#each entry = day.entries}}\n            <div class="entry">\n                <p><span class="entry-time">{{ entry.timestamp | time }}</span>: <span class="entry-activity">{{ entry.activity | escapeHtml }}</span></p>\n                {{#if entry.description}}\n                <div class="entry-description">{{ entry.description | markdown }}</div>\n                {{/if}}\n                <p class="duration">Duration: {{ entry.duration | duration }}</p>\n            </div>\n            {{/each}}\n        </div>\n        {{/each}}\n    </div>\n</body>\n</html>'},"summary-markdown":{name:"Summary (Markdown)",description:"A summary report in Markdown, suitable for pasting into documents.",type:"markdown",template:"# Activity Report\n\n**Period:** {{ report.startDate | date('dd mmm yyyy') }} to {{ report.endDate | date('dd mmm yyyy') }}\n\n## Summary\n- **Total Entries:** {{ report.totalEntries }}\n- **Total Duration:** {{ report.totalDuration | duration }}\n- **Active Days:** {{ report.activeDays }}\n\n---\n\n{{#each day = days}}\n## {{ day.date }} (Total: {{ day.totalDuration | duration }})\n{{#each entry = day.entries}}\n- **{{ entry.timestamp | time }} ({{ entry.duration | duration }})**: {{ entry.activity }}\n{{/each}}\n{{/each}}"},"basic-csv":{name:"Basic Export (CSV)",description:"A simple CSV file with core activity data.",type:"csv",template:"Date,Time,Activity,Description\n{{#each entry = entries}}{{ entry.timestamp | date('yyyy-mm-dd') }},{{ entry.timestamp | time }},{{ entry.activity | escapeCsv | stripLinebreaks }},{{ entry.description | escapeCsv | stripLinebreaks }}\n{{/each}}"},"timed-csv":{name:"Timed Export (CSV)",description:"A detailed CSV file including calculated durations.",type:"csv",template:'Date,StartTime,EndTime,DurationMinutes,Activity,Description\n{{#each entry = entries}}{{ entry.timestamp | date(\'yyyy-mm-dd\') }},{{ entry.timestamp | time }},{{ entry.endTime | time }},{{ entry.duration }},"{{ entry.activity | escapeCsv | stripLinebreaks }}","{{ entry.description | escapeCsv | stripLinebreaks }}"\n{{/each}}'}};class ActivityTracker{constructor(){let t=[];try{const e=JSON.parse(localStorage.getItem("activityEntries"));Array.isArray(e)&&(t=e.filter(t=>t&&"object"==typeof t&&t.timestamp))}catch(t){console.error("Error parsing activity entries from localStorage",t),localStorage.removeItem("activityEntries")}this.entries=t,this.settings={notificationInterval:60,startTime:"08:00",endTime:"18:00",workingDays:{monday:!0,tuesday:!0,wednesday:!0,thursday:!0,friday:!0,saturday:!1,sunday:!1},pauseDuration:60,notificationsPausedUntil:null,notificationsEnabled:!0,muteNotificationSound:!1,notificationSoundType:"classic",darkMode:!1,...JSON.parse(localStorage.getItem("activitySettings")||"{}")},this.notificationTimer=null,this.currentReportEntries=[],this.currentWeekStart=null,this.soundManager=null,this.pauseManager=null,this.init()}init(){this.loadSettings(),this.initMarkdownRenderer(),this.initReportTemplates(),this.loadReportTemplatesIntoEditor(),this.displayEntries(),this.updateNotificationStatus(),this.updateDebugInfo(),this.updatePauseButtonState(),this.startNotificationTimer(),this.setWeeklyReport(),this.initSoundManager(),this.initPauseManager(),this.attachEventListeners(),this.setCurrentTime(),document.getElementById("activity").focus(),"file:"===window.location.protocol&&console.warn("Running from local file - notifications may have limitations")}getReportTemplates(){const t=localStorage.getItem("reportTemplates");if(t)try{return JSON.parse(t)}catch(t){return console.error("Error parsing custom report templates from localStorage",t),window.ReportTemplates||{}}return window.ReportTemplates||{}}loadReportTemplatesIntoEditor(){const t=document.getElementById("report-templates-editor");if(!t)return;const e=this.getReportTemplates();t.innerHTML=Object.keys(e).map(t=>`\n            <div class="template-group">\n                <label for="template-${t}">${e[t].name}</label>\n                <textarea id="template-${t}" data-key="${t}">${escapeHtml(e[t].template)}</textarea>\n            </div>\n        `).join("")}saveReportTemplates(){const t=document.getElementById("report-templates-editor");if(!t)return;const e=this.getReportTemplates();t.querySelectorAll("textarea").forEach(t=>{const i=t.dataset.key;e[i]&&(e[i].template=t.value)}),localStorage.setItem("reportTemplates",JSON.stringify(e)),showNotification("Report templates saved successfully!","success"),this.initReportTemplates(),this.currentReportData&&this.previewReport()}resetReportTemplates(){confirm("Are you sure you want to reset all report templates to their default values?")&&(localStorage.removeItem("reportTemplates"),this.loadReportTemplatesIntoEditor(),this.initReportTemplates(),this.currentReportData&&this.previewReport(),showNotification("Report templates have been reset to default.","success"))}initMarkdownRenderer(){try{this.markdownRenderer=new MarkdownRenderer}catch(t){console.warn("Markdown Renderer initialization failed:",t)}}initPauseManager(){try{this.pauseManager=new PauseManager(this)}catch(t){console.warn("Pause Manager initialization failed:",t)}}attachEventListeners(){document.getElementById("activityForm").addEventListener("submit",t=>{t.preventDefault(),this.addEntry()}),document.getElementById("editForm").addEventListener("submit",t=>{t.preventDefault(),this.updateEntry()}),this.attachSettingsListeners()}attachSettingsListeners(){["notificationInterval","startTime","endTime","pauseDuration","muteNotificationSound","notificationSoundType","darkMode","monday","tuesday","wednesday","thursday","friday","saturday","sunday"].forEach(t=>{const e=document.getElementById(t);if(e){let t;t="checkbox"===e.type||"select"===e.tagName.toLowerCase()?"change":"input",e.addEventListener(t,()=>{this.autoSaveSettings()})}})}autoSaveSettings(){this.settings.notificationInterval=parseInt(document.getElementById("notificationInterval").value),this.settings.startTime=document.getElementById("startTime").value,this.settings.endTime=document.getElementById("endTime").value,this.settings.pauseDuration=parseInt(document.getElementById("pauseDuration").value),this.settings.muteNotificationSound=document.getElementById("muteNotificationSound").checked,this.settings.notificationSoundType=document.getElementById("notificationSoundType").value,this.settings.darkMode=document.getElementById("darkMode").checked,["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].forEach(t=>{this.settings.workingDays[t]=document.getElementById(t).checked}),this.applyTheme(),this.saveSettings(),this.settings.notificationsEnabled&&this.startNotificationTimer(),this.updateDebugInfo(),showNotification("Settings saved automatically","success",1500)}initSoundManager(){try{this.soundManager=new SoundManager}catch(t){console.warn("Sound Manager failed to initialise:",t)}}playNotificationSound(){this.soundManager&&this.soundManager.playSound(this.settings.notificationSoundType,this.settings.muteNotificationSound)}testNotificationSound(){this.soundManager&&this.soundManager.playSound(this.settings.notificationSoundType,this.settings.muteNotificationSound),showNotification("Test sound played!","success")}addEntry(t){let e=t;if(!e){const t=document.getElementById("activity").value,i=document.getElementById("description").value,n=document.getElementById("timestamp").value;e={id:generateId(),activity:t,description:i,timestamp:new Date(n).toISOString(),created:(new Date).toISOString()}}this.entries.unshift(e),this.saveEntries(),this.displayEntries(),t||(document.getElementById("activityForm").reset(),this.setCurrentTime(),document.getElementById("activity").focus()),showNotification("Entry added successfully!","success")}updateEntry(){const t=document.getElementById("editId").value,e=document.getElementById("editActivity").value,i=document.getElementById("editDescription").value,n=document.getElementById("editTimestamp").value,a=this.entries.findIndex(e=>e.id===t);-1!==a&&(this.entries[a]={...this.entries[a],activity:e,description:i,timestamp:new Date(n).toISOString()},this.saveEntries(),this.displayEntries(),this.closeEditModal(),showNotification("Entry updated successfully!","success"))}deleteEntry(t){confirm("Are you sure you want to delete this entry?")&&(this.entries=this.entries.filter(e=>e.id!==t),this.saveEntries(),this.displayEntries(),showNotification("Entry deleted successfully!","success"))}editEntry(t){const e=this.entries.find(e=>e.id===t);e&&(document.getElementById("editId").value=e.id,document.getElementById("editActivity").value=e.activity,document.getElementById("editDescription").value=e.description||"",document.getElementById("editTimestamp").value=new Date(e.timestamp).toISOString().slice(0,16),document.getElementById("editModal").classList.add("active"))}closeEditModal(){document.getElementById("editModal").classList.remove("active")}displayEntries(){const t=document.getElementById("entriesList"),e=this.entries.slice(0,20);0!==e.length?t.innerHTML=e.map(t=>`\n            <div class="entry-item">\n                <div class="entry-content">\n                    <div class="entry-time">${formatDateTime(t.timestamp)}</div>\n                    <div class="entry-activity">${escapeHtml(t.activity)}</div>\n                    ${t.description?`<div class="entry-description">${this.renderDescriptionMarkdown(t.description)}</div>`:""}\n                </div>\n                <div class="entry-actions">\n                    <button class="btn btn-secondary" onclick="tracker.editEntry('${t.id}')">Edit</button>\n                    <button class="btn btn-danger" onclick="tracker.deleteEntry('${t.id}')">Delete</button>\n                </div>\n            </div>\n        `).join(""):t.innerHTML="<p>No entries yet. Add your first activity above!</p>"}renderDescriptionMarkdown(t){return this.markdownRenderer||void 0===MarkdownRenderer||this.initMarkdownRenderer(),this.markdownRenderer&&t?this.markdownRenderer.renderInlineWithClasses(t):escapeHtml(t)}saveEntries(){localStorage.setItem("activityEntries",JSON.stringify(this.entries))}saveSettings(){this.settings={...this.settings,notificationInterval:parseInt(document.getElementById("notificationInterval").value),startTime:document.getElementById("startTime").value,endTime:document.getElementById("endTime").value,pauseDuration:parseInt(document.getElementById("pauseDuration").value),muteNotificationSound:document.getElementById("muteNotificationSound").checked,notificationSoundType:document.getElementById("notificationSoundType").value,darkMode:document.getElementById("darkMode").checked,workingDays:{monday:document.getElementById("monday").checked,tuesday:document.getElementById("tuesday").checked,wednesday:document.getElementById("wednesday").checked,thursday:document.getElementById("thursday").checked,friday:document.getElementById("friday").checked,saturday:document.getElementById("saturday").checked,sunday:document.getElementById("sunday").checked}},localStorage.setItem("activitySettings",JSON.stringify(this.settings)),this.applyTheme(),this.startNotificationTimer(),showNotification("Settings saved successfully!","success")}loadSettings(){document.getElementById("notificationInterval").value=this.settings.notificationInterval,document.getElementById("startTime").value=this.settings.startTime,document.getElementById("endTime").value=this.settings.endTime,document.getElementById("pauseDuration").value=this.settings.pauseDuration,document.getElementById("muteNotificationSound").checked=this.settings.muteNotificationSound,document.getElementById("notificationSoundType").value=this.settings.notificationSoundType,document.getElementById("darkMode").checked=this.settings.darkMode,Object.entries(this.settings.workingDays).forEach(([t,e])=>{document.getElementById(t).checked=e}),this.applyTheme()}applyTheme(){this.settings.darkMode?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode")}async enableNotifications(){if(!("Notification"in window)||!("serviceWorker"in navigator))return alert("This browser does not support notifications or service workers."),void this.updateDebugInfo();if(this.settings.notificationsEnabled&&"granted"===Notification.permission)return this.settings.notificationsEnabled=!1,this.saveSettings(),this.stopNotificationTimer(),showNotification("Notifications disabled","success"),this.updateNotificationStatus(),void this.updateDebugInfo();try{const t=await Notification.requestPermission();"granted"===t?(this.settings.notificationsEnabled=!0,this.saveSettings(),showNotification("Notifications enabled successfully!","success"),this.startNotificationTimer(),setTimeout(()=>{this.testNotification(!0)},1e3)):showNotification("denied"===t?"Notifications were denied. Please check your browser settings and try again.":"Notification permission was not granted. Please try again.","error"),setTimeout(()=>{this.updateNotificationStatus(),this.updateDebugInfo()},500)}catch(t){console.error("Error requesting notification permission:",t),showNotification("Error requesting notification permission: "+t.message,"error"),this.updateDebugInfo()}}async showNotificationWithServiceWorker(t,e){if("Notification"in window)if("granted"===Notification.permission){try{if("serviceWorker"in navigator&&navigator.serviceWorker.controller){const i=await navigator.serviceWorker.ready;return void await i.showNotification(t,e)}}catch(t){console.warn("Service Worker notification failed, falling back to direct notification:",t)}try{const i={body:e.body,icon:e.icon,tag:e.tag,requireInteraction:e.requireInteraction},n=new Notification(t,i);n.onclick=()=>{window.focus(),n.close()},e.requireInteraction||setTimeout(()=>{n.close()},5e3)}catch(t){console.error("Both Service Worker and direct notification failed:",t),showNotification("Activity reminder: "+(e.body||"Time to log your activity!"),"info",8e3)}}else console.warn("Notification permission not granted");else console.warn("Notifications not supported")}testNotification(t=!1){if(this.updateDebugInfo(),this.playNotificationSound(),"granted"===Notification.permission)try{const e={body:"This is a test notification. If you can see this, notifications are working correctly!",icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23667eea"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',tag:"test-notification",requireInteraction:!1,actions:[{action:"reply",type:"text",title:"Log Activity",placeholder:"e.g. coding"}]};this.showNotificationWithServiceWorker("Activity Tracker Test",e),t||showNotification("Test notification sent successfully!","success")}catch(t){console.error("Error creating test notification:",t),showNotification("Error creating test notification: "+t.message,"error"),this.updateDebugInfo()}else t||showNotification("Please enable notifications first! Current permission: "+Notification.permission,"error")}refreshNotificationStatus(){this.updateNotificationStatus(),this.updateDebugInfo(),showNotification("Notification status refreshed","success")}updateNotificationStatus(){const t=document.getElementById("notificationStatus"),e=document.getElementById("statusIndicator"),i=document.getElementById("statusText"),n=document.querySelector('button[onclick="enableNotifications()"]');if("Notification"in window)switch(Notification.permission){case"granted":this.settings.notificationsEnabled?(t.className="notification-status notification-enabled",e.className="status-indicator status-active",i.textContent="Notifications are enabled and working",n&&(n.textContent="Disable Notifications")):(t.className="notification-status notification-warning",e.className="status-indicator status-inactive",i.textContent="Notifications are disabled by user",n&&(n.textContent="Enable Notifications"));break;case"denied":t.className="notification-status notification-disabled",e.className="status-indicator status-inactive",i.textContent="Notifications are blocked - please enable them in browser settings",n&&(n.textContent="Enable Notifications");break;default:t.className="notification-status notification-warning",e.className="status-indicator status-inactive",i.textContent='Notifications are disabled - click "Enable Notifications" to activate',n&&(n.textContent="Enable Notifications")}else t.className="notification-status notification-disabled",e.className="status-indicator status-inactive",i.textContent="Notifications not supported in this browser",n&&(n.textContent="Not Supported");"file:"===window.location.protocol&&(t.className="notification-status notification-warning",i.textContent+=" (Note: Running from local file may limit notification functionality)")}updateDebugInfo(){const t=document.getElementById("debugText"),e=[];e.push(`Version: ${APP_VERSION}`),e.push(""),e.push(`Browser: ${navigator.userAgent.split(" ").slice(-2).join(" ")}`),e.push(`Platform: ${navigator.platform||"Unknown"}`),e.push(`Protocol: ${window.location.protocol}`),e.push("Notification API: "+("Notification"in window?"Available":"Not Available")),"Notification"in window&&(e.push(`Permission: ${Notification.permission}`),e.push(`Max Actions: ${Notification.maxActions||"Unknown"}`)),"serviceWorker"in navigator?(e.push("Service Worker: Available"),navigator.serviceWorker.controller?(e.push(`SW State: ${navigator.serviceWorker.controller.state}`),e.push(`SW URL: ${navigator.serviceWorker.controller.scriptURL.split("/").pop()}`)):e.push("SW State: No controller"),navigator.serviceWorker.getRegistration().then(t=>{if(t){const e=document.getElementById("debugText");e&&e.innerHTML.includes("SW Scope: Checking...")&&(e.innerHTML=e.innerHTML.replace("SW Scope: Checking...",`SW Scope: ${t.scope}`))}}).catch(t=>{console.warn("SW registration check failed:",t)}),e.push("SW Scope: Checking...")):(e.push("Service Worker: Not Available"),"file:"===window.location.protocol&&e.push("SW Reason: file:// protocol (expected)")),e.push("Web Audio API: "+(this.audioContext?"Available":"Not Available")),e.push("Sound Muted: "+(this.settings.muteNotificationSound?"Yes":"No")),e.push(`Sound Type: ${this.settings.notificationSoundType}`),e.push(`Last Updated: ${(new Date).toLocaleTimeString("en-GB")}`),t.innerHTML=e.join("<br>")}async runServiceWorkerDiagnostics(){const t={available:"serviceWorker"in navigator,protocol:window.location.protocol,userAgent:navigator.userAgent,platform:navigator.platform,registration:null,controller:null,error:null};if(!t.available)return t.error="Service Worker API not available",t;try{if(t.registration=await navigator.serviceWorker.getRegistration(),t.controller=navigator.serviceWorker.controller,t.controller)try{const e=new MessageChannel,i=await new Promise((i,n)=>{const a=setTimeout(()=>n(new Error("SW communication timeout")),5e3);e.port1.onmessage=t=>{clearTimeout(a),i(t.data)},t.controller.postMessage({type:"GET_VERSION"},[e.port2])});t.communication="Working",t.swVersion=i.version}catch(e){t.communication=`Failed: ${e.message}`}}catch(e){t.error=e.message}return t}startNotificationTimer(){this.notificationTimer&&clearInterval(this.notificationTimer),this.notificationTimer=setInterval(()=>{this.checkForNotification()},6e4)}stopNotificationTimer(){this.notificationTimer&&(clearInterval(this.notificationTimer),this.notificationTimer=null)}checkForNotification(){if(!this.settings.notificationsEnabled)return;if(this.settings.notificationsPausedUntil){if((new Date).getTime()<this.settings.notificationsPausedUntil)return;this.unpauseNotifications(!1)}if("granted"!==Notification.permission)return;const t=new Date,e=60*t.getHours()+t.getMinutes(),i=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][t.getDay()];if(!this.settings.workingDays[i])return;const[n,a]=this.settings.startTime.split(":").map(Number),[o,r]=this.settings.endTime.split(":").map(Number);if(e<60*n+a||e>60*o+r)return;const s=localStorage.getItem("lastNotificationTime"),c=t.getTime()-(s||0),l=60*this.settings.notificationInterval*1e3;l>0&&c>=l&&(this.showActivityReminder(),localStorage.setItem("lastNotificationTime",t.getTime().toString()))}showActivityReminder(){this.playNotificationSound(),this.setCurrentTime();try{const t={body:"What are you working on right now?",icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23667eea"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',tag:"activity-reminder",requireInteraction:!0,actions:[{action:"reply",type:"text",title:"Log Activity",placeholder:"e.g. coding"}]};this.showNotificationWithServiceWorker("Activity Tracker Reminder",t)}catch(t){console.error("Error showing activity reminder:",t)}}setCurrentTime(){const t=document.getElementById("timestamp");t&&(t.value=getCurrentTimeForInput())}togglePause(t=!0){if(this.settings.notificationsPausedUntil)this.pauseManager?this.pauseManager.resume():this.unpauseNotifications(t);else if(this.pauseManager)this.pauseManager.startPause(this.settings.pauseDuration);else{const t=this.settings.pauseDuration;this.settings.notificationsPausedUntil=-1===t?1/0:(new Date).getTime()+60*t*1e3,this.updatePauseButtonState(),this.saveSettings()}t&&showNotification(this.settings.notificationsPausedUntil?"Notifications paused":"Notifications resumed",this.settings.notificationsPausedUntil?"info":"success")}unpauseNotifications(t=!0){this.settings.notificationsPausedUntil=null,t&&showNotification("Notifications resumed","success"),this.updatePauseButtonState(),this.saveSettings()}updatePauseButtonState(){this.pauseManager&&this.pauseManager.updatePauseButtonDisplay()}clearAllData(){confirm("Are you sure you want to clear all data? This cannot be undone.")&&(localStorage.removeItem("activityEntries"),localStorage.removeItem("activitySettings"),localStorage.removeItem("lastNotificationTime"),this.entries=[],this.currentReportEntries=[],this.displayEntries(),document.getElementById("reportPreview").innerHTML="",showNotification("All data cleared successfully!","success"))}exportDatabase(){try{const t={version:"1.0",timestamp:(new Date).toISOString(),entries:this.entries,settings:this.settings},e=JSON.stringify(t,null,2),i=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(i),a=document.createElement("a");a.href=n,a.download=`activity-tracker-backup-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n),showNotification("Database exported successfully!","success")}catch(t){console.error("Error exporting database:",t),showNotification("Error exporting database: "+t.message,"error")}}importDatabase(t){try{const e=JSON.parse(t);if(!e.entries||!Array.isArray(e.entries))throw new Error("Invalid backup file: missing or invalid entries data");const i=e.entries.length,n=e.timestamp?new Date(e.timestamp).toLocaleDateString("en-GB"):"unknown date";if(!confirm(`Import ${i} entries from backup created on ${n}? This will replace all current data.`))return;const a=e.entries.filter(t=>t&&"object"==typeof t&&t.timestamp);a.length!==e.entries.length&&console.warn(`Filtered out ${e.entries.length-a.length} invalid entries`),this.entries=a,localStorage.setItem("activityEntries",JSON.stringify(this.entries)),e.settings&&"object"==typeof e.settings&&(this.settings={...this.settings,...e.settings},localStorage.setItem("activitySettings",JSON.stringify(this.settings)),this.loadSettings()),this.displayEntries(),this.currentReportEntries=[],document.getElementById("reportPreview").innerHTML="",showNotification(`Database imported successfully! Restored ${a.length} entries.`,"success")}catch(t){console.error("Error importing database:",t),showNotification("Error importing database: "+t.message,"error")}}}function getWeekStart(t){const e=(t=new Date(t)).getDay(),i=t.getDate()-e+(0===e?-6:1);return new Date(t.setDate(i))}function getWeekEnd(t){const e=getWeekStart(t),i=new Date(e);return i.setDate(e.getDate()+6),i}let tracker,deferredPrompt;function showSection(t,e){if(document.querySelectorAll(".section").forEach(t=>{t.classList.remove("active")}),document.getElementById(t).classList.add("active"),document.querySelectorAll(".nav-btn").forEach(t=>{t.classList.remove("active")}),e&&e.target)e.target.classList.add("active");else{const e=document.querySelector(`.nav-btn[onclick*="'${t}'"]`);e&&e.classList.add("active")}if("tracker"===t&&setTimeout(()=>{const t=document.getElementById("activity");t&&t.focus()},100),"reports"===t){const t=document.getElementById("reportResults");!tracker||t&&t.innerHTML.trim()||tracker.setWeeklyReport()}}function addCurrentTime(){tracker&&tracker.setCurrentTime()}function generateReport(){tracker&&tracker.generateReport()}function setWeeklyReport(){tracker&&tracker.setWeeklyReport()}function previousWeek(){tracker&&tracker.previousWeek()}function nextWeek(){tracker&&tracker.nextWeek()}function downloadReport(){tracker&&tracker.downloadReport()}function saveSettings(){tracker&&tracker.saveSettings()}function enableNotifications(){tracker&&tracker.enableNotifications()}function testNotification(){tracker&&tracker.testNotification()}function testNotificationSound(){tracker&&tracker.testNotificationSound()}function refreshNotificationStatus(){tracker&&tracker.refreshNotificationStatus()}function clearAllData(){tracker&&tracker.clearAllData()}function closeEditModal(){tracker&&tracker.closeEditModal()}function togglePause(){tracker&&tracker.togglePause()}function saveReportTemplates(){tracker&&tracker.saveReportTemplates()}function resetReportTemplates(){tracker&&tracker.resetReportTemplates()}function exportDatabase(){tracker&&tracker.exportDatabase()}function importDatabase(){const t=document.getElementById("importFile");t&&t.click()}function handleImportFile(t){const e=t.target.files[0];if(!e)return;if("application/json"!==e.type&&!e.name.endsWith(".json"))return void showNotification("Please select a valid JSON backup file.","error");const i=new FileReader;i.onload=function(e){tracker&&tracker.importDatabase(e.target.result),t.target.value=""},i.onerror=function(){showNotification("Error reading backup file.","error"),t.target.value=""},i.readAsText(e)}async function runServiceWorkerTest(){if(tracker){showNotification("Running Service Worker diagnostics...","info");try{const t=await tracker.runServiceWorkerDiagnostics();let e="Service Worker Diagnostics:\n\n";e+=`Available: ${t.available}\n`,e+=`Protocol: ${t.protocol}\n`,e+=`Platform: ${t.platform}\n`,t.registration?(e+="Registration: Active\n",e+=`Scope: ${t.registration.scope}\n`):e+="Registration: None\n",t.controller?e+=`Controller: Active (${t.controller.state})\n`:e+="Controller: None\n",t.communication&&(e+=`Communication: ${t.communication}\n`),t.swVersion&&(e+=`SW Version: ${t.swVersion}\n`),t.error&&(e+=`Error: ${t.error}\n`),alert(e);const i=t.available&&t.registration?"success":"warning";showNotification(t.available&&t.registration?"Service Worker is working correctly":"Service Worker issues detected (see console)",i)}catch(t){console.error("Diagnostic test failed:",t),showNotification("Diagnostic test failed: "+t.message,"error")}}else showNotification("Tracker not initialized","error")}Object.assign(ActivityTracker.prototype,{initReportTemplates(){this.templatingEngine=new TemplatingEngine;const t=document.getElementById("reportTemplate");if(!t)return;const e=this.getReportTemplates();t.innerHTML=Object.keys(e).map(t=>`<option value="${t}">${e[t].name}</option>`).join("")},prepareReportData(t,e,i){const n=[...t].sort((t,e)=>new Date(t.timestamp)-new Date(e.timestamp)),a=n.map((t,e)=>{t.timestamp||console.error("Entry missing timestamp:",t);const i=n[e+1];let a,o;if(i)a=new Date(i.timestamp),o=Math.round((a-new Date(t.timestamp))/6e4);else{const e=new Date(t.timestamp),[i,n]=this.settings.endTime.split(":").map(Number);e.setHours(i,n,0,0),a=new Date(Math.min(new Date,e)),o=Math.round((a-new Date(t.timestamp))/6e4)}return{...t,endTime:a,duration:o}}),o={};a.forEach(t=>{const e=new Date(t.timestamp).toLocaleDateString("en-GB",{weekday:"long",year:"numeric",month:"long",day:"numeric"});o[e]||(o[e]={entries:[],totalDuration:0}),o[e].entries.push(t),o[e].totalDuration+=t.duration>0?t.duration:0});const r=Object.keys(o).map(t=>({date:t,entries:o[t].entries,totalDuration:o[t].totalDuration})),s=r.reduce((t,e)=>t+e.totalDuration,0);return{report:{startDate:e,endDate:i,generatedDate:new Date,totalEntries:a.length,totalDuration:s,activeDays:r.length},days:r,entries:a}},renderReport(t,e){return this.templatingEngine.render(t,e)},generateReport(){const t=document.getElementById("reportStartDate").value,e=document.getElementById("reportEndDate").value;if(!t||!e)return void showNotification("Please select both start and end dates","error");const i=new Date(t),n=new Date(e);n.setHours(23,59,59,999);const a=this.entries.filter(t=>{const e=new Date(t.timestamp);return e>=i&&e<=n});this.currentReportEntries=a,this.currentReportData=this.prepareReportData(a,i,n),this.previewReport()},previewReport(){const t=document.getElementById("reportPreview");if(!t)return;if(!this.currentReportData||0===this.currentReportEntries.length)return void(t.innerHTML="No data for the selected period. Generate a report first.");this.currentReportData.days&&this.currentReportData.days[0]&&this.currentReportData.days[0].entries&&this.currentReportData.days[0].entries[0];const e=document.getElementById("reportTemplate").value,i=this.getReportTemplates()[e];if(!i)return void(t.textContent="Error: Selected report template not found.");const n=this.renderReport(i.template,this.currentReportData);"html"===i.type?t.innerHTML=`<iframe srcdoc="${this.templatingEngine.escapeHtml(n)}" style="width: 100%; height: 450px; border: none;"></iframe>`:t.innerHTML=`<pre>${this.templatingEngine.escapeHtml(n)}</pre>`},downloadReport(){if(!this.currentReportData||0===this.currentReportEntries.length)return void showNotification("Please generate a report with data first","error");const t=document.getElementById("reportTemplate").value,e=this.getReportTemplates()[t],i=this.currentReportData.report.startDate,n=this.currentReportData.report.endDate,a=this.renderReport(e.template,this.currentReportData),o=e.type,r={html:"text/html",markdown:"text/markdown",csv:"text/csv"}[o]||"text/plain";downloadFile(a,`activity-report-${this.templatingEngine.formatDate(i,"yyyy-mm-dd")}-to-${this.templatingEngine.formatDate(n,"yyyy-mm-dd")}.${o}`,r),showNotification(`Report downloaded as ${e.name}`,"success")},setWeeklyReport(){const t=new Date;this.currentWeekStart=getWeekStart(t),this.updateWeekFromCurrent(),this.generateReport()},previousWeek(){this.currentWeekStart||(this.currentWeekStart=getWeekStart(new Date)),this.currentWeekStart.setDate(this.currentWeekStart.getDate()-7),this.updateWeekFromCurrent(),this.generateReport()},nextWeek(){this.currentWeekStart||(this.currentWeekStart=getWeekStart(new Date)),this.currentWeekStart.setDate(this.currentWeekStart.getDate()+7),this.updateWeekFromCurrent(),this.generateReport()},updateWeekFromCurrent(){const t=new Date(this.currentWeekStart),e=getWeekEnd(t);document.getElementById("reportStartDate").value=t.toISOString().split("T")[0],document.getElementById("reportEndDate").value=e.toISOString().split("T")[0],this.updateWeekDisplay()},updateWeekDisplay(){if(!this.currentWeekStart)return;const t=new Date(this.currentWeekStart),e=getWeekEnd(t),i=`Week of ${t.toLocaleDateString("en-GB",{day:"numeric",month:"short"})} - ${e.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}`;document.getElementById("weekDisplay").textContent=i}}),document.addEventListener("DOMContentLoaded",()=>{tracker=new ActivityTracker,"serviceWorker"in navigator&&("file:"===window.location.protocol||navigator.serviceWorker.register("./sw.js").then(t=>{t.addEventListener("updatefound",()=>{const e=t.installing;e&&e.addEventListener("statechange",()=>{"installed"===e.state&&navigator.serviceWorker.controller&&showNotification("App updated! Refresh for latest version.","info",1e4)})}),tracker&&tracker.updateDebugInfo()}).catch(t=>{console.error("❌ Service Worker registration failed:",t),navigator.platform.includes("Mac")&&"SecurityError"===t.name&&(console.warn("🍎 macOS Security Error: This may be due to strict security settings"),console.warn("💡 Try serving over HTTP/HTTPS instead of file://")),tracker&&tracker.updateDebugInfo()}),navigator.serviceWorker.addEventListener("message",t=>{t.data&&"add-entry"===t.data.type&&tracker&&(tracker.addEntry(t.data.entry),showNotification("Activity logged from notification!","success")),t.data&&"navigate-to-tracker"===t.data.type&&showSection("tracker")}),navigator.serviceWorker.addEventListener("controllerchange",()=>{tracker&&tracker.updateDebugInfo()})),"#tracker"===window.location.hash&&(showSection("tracker"),history.replaceState(null,document.title,window.location.pathname+window.location.search))}),document.addEventListener("click",t=>{t.target.classList.contains("modal")&&closeEditModal()}),document.addEventListener("keydown",t=>{if("Escape"===t.key&&closeEditModal(),(t.ctrlKey||t.metaKey)&&"Enter"===t.key){const t=document.activeElement;if(t&&("activity"===t.id||"description"===t.id)){const t=document.getElementById("activityForm");t&&t.dispatchEvent(new Event("submit"))}}}),document.addEventListener("visibilitychange",()=>{tracker&&(document.hidden||tracker.updateDebugInfo())}),window.addEventListener("online",()=>{showNotification("Connection restored","success")}),window.addEventListener("offline",()=>{showNotification("Working offline","info")}),window.addEventListener("beforeunload",t=>{tracker&&tracker.pauseManager&&tracker.pauseManager.destroy();const e=document.getElementById("activity");if(e&&e.value.trim())return t.preventDefault(),t.returnValue="You have unsaved activity data. Are you sure you want to leave?",t.returnValue}),window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),deferredPrompt=t,showNotification("This app can be installed on your device!","info")}),window.addEventListener("appinstalled",()=>{showNotification("Activity Tracker installed successfully!","success"),deferredPrompt=null}),window.addEventListener("error",t=>{console.error("❌ Uncaught error:",t.error),showNotification("An unexpected error occurred. Please refresh the page.","error")}),window.addEventListener("unhandledrejection",t=>{console.error("❌ Unhandled promise rejection:",t.reason),showNotification("An unexpected error occurred. Please refresh the page.","error")}),window.addEventListener("load",()=>{if(window.performance&&window.performance.timing){const t=window.performance.timing;t.loadEventEnd,t.navigationStart}}),"undefined"!=typeof module&&module.exports&&(module.exports={showSection:showSection,addCurrentTime:addCurrentTime,generateReport:generateReport,setWeeklyReport:setWeeklyReport,previousWeek:previousWeek,nextWeek:nextWeek,downloadReport:downloadReport,saveSettings:saveSettings,enableNotifications:enableNotifications,testNotification:testNotification,testNotificationSound:testNotificationSound,refreshNotificationStatus:refreshNotificationStatus,clearAllData:clearAllData,closeEditModal:closeEditModal,togglePause:togglePause,exportDatabase:exportDatabase,importDatabase:importDatabase,handleImportFile:handleImportFile,runServiceWorkerTest:runServiceWorkerTest});</script></body></html>