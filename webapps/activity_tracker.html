<!doctype html><html lang="en-GB"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="favicon.ico" type="image/x-icon"><title>Activity Tracker</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);min-height:100vh;color:#333}.container{max-width:1200px;margin:0 auto;padding:20px}.header{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 8px 32px rgba(0,0,0,.1)}.nav{display:flex;gap:15px;margin-top:15px}.nav-btn{padding:10px 20px;border:none;background:#667eea;color:#fff;border-radius:8px;cursor:pointer;font-weight:500}.nav-btn:hover{background:#5a67d8;transform:translateY(-2px)}.nav-btn.active{background:#4c51bf;box-shadow:0 4px 15px rgba(76,81,191,.4)}.section{display:none;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:15px;padding:30px;box-shadow:0 8px 32px rgba(0,0,0,.1)}.section.active{display:block}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:600;color:#4a5568}.form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:16px;transition:border-color .3s}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:0;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}.form-group-buttons{margin-top:32px}.btn{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:16px;transition:.3s;margin-right:10px;margin-bottom:10px}.btn-primary{background:#667eea;color:#fff}.btn-primary:hover{background:#5a67d8;transform:translateY(-2px)}.btn-secondary{background:#718096;color:#fff}.btn-secondary:hover{background:#4a5568}.btn-danger{background:#e53e3e;color:#fff}.btn-danger:hover{background:#c53030}.btn-success{background:#38a169;color:#fff}.btn-success:hover{background:#2f855a}.entries-list{margin-top:30px}.entry-item{background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:20px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:flex-start}.entry-content{flex:1}.entry-time{font-weight:600;color:#667eea;margin-bottom:5px}.entry-activity{font-size:18px;margin-bottom:5px}.entry-description{color:#718096;font-size:14px}.entry-description .md-paragraph{margin:5px 0}.entry-description .md-list{margin:5px 0;padding-left:20px}.entry-description .md-blockquote{margin:8px 0;padding:5px 10px;font-size:13px}.entry-description .md-code{font-size:12px}.entry-actions{display:flex;gap:10px}.settings-buttons-section{margin-bottom:30px}.settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-bottom:30px}.data-management-section{margin-bottom:30px}.data-management-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px}.about-section{margin-bottom:30px}.settings-section{background:#f7fafc;padding:20px;border-radius:8px;border:1px solid #e2e8f0}.settings-section h3{margin-bottom:8px;color:#2d3748}.settings-description{font-size:14px;color:#718096;margin-bottom:20px;margin-top:0}.settings-toggles{margin-top:20px;padding-top:15px;border-top:1px solid #e2e8f0}.time-inputs{display:grid;grid-template-columns:1fr 1fr;gap:15px}.working-days-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}.settings-card{background:#fff;border:2px solid #e2e8f0;border-radius:12px;padding:24px;transition:.3s;position:relative;overflow:hidden}.settings-card:hover{border-color:#667eea;box-shadow:0 8px 25px rgba(102,126,234,.15);transform:translateY(-2px)}.settings-card h3{margin-bottom:8px;color:#2d3748;font-size:18px}.card-description{font-size:14px;color:#718096;margin-bottom:20px;line-height:1.5}.card-actions{display:flex;gap:12px;flex-wrap:wrap}.about-section .debug-info{margin-top:0}.checkbox-group{display:flex;align-items:center;margin-bottom:10px}.checkbox-group input[type=checkbox]{width:auto;margin-right:10px}.notification-status{padding:10px;border-radius:8px;margin-bottom:20px;text-align:center;font-weight:600}.notification-enabled{background:#c6f6d5;color:#22543d}.notification-disabled{background:#fed7d7;color:#742a2a}.notification-warning{background:#fef5e7;color:#744210}.report-filters{background:#f7fafc;padding:20px;border-radius:8px;margin-bottom:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;align-items:end}.report-summary{background:#e6fffa;padding:20px;border-radius:8px;margin-bottom:20px;border-left:4px solid #38b2ac}.report-navigation{display:flex;gap:10px;align-items:center;margin-bottom:20px}.week-display{background:#f7fafc;padding:10px 15px;border-radius:8px;font-weight:600;min-width:200px;text-align:center}.download-section{background:#f0fff4;padding:20px;border-radius:8px;margin-top:20px;border-left:4px solid #38a169}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000}.modal.active{display:flex;align-items:center;justify-content:center}.modal-content{background:#fff;padding:30px;border-radius:15px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}.status-indicator{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px}.status-active{background:#48bb78}.status-inactive{background:#f56565}.backup-buttons,.notification-buttons{display:flex;gap:10px;flex-wrap:wrap}.debug-info{background:#f7fafc;padding:15px;border-radius:8px;margin-top:15px;font-family:monospace;font-size:14px;border-left:4px solid #667eea}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}.markdown-preview{background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:20px;margin:15px 0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.6}.markdown-preview .md-h1{color:#2d3748;border-bottom:2px solid #667eea;padding-bottom:10px;margin:20px 0 15px}.markdown-preview .md-h2{color:#2d3748;border-bottom:1px solid #e2e8f0;padding-bottom:5px;margin:18px 0 12px}.markdown-preview .md-h3{color:#4a5568;margin:15px 0 10px}.markdown-preview .md-blockquote{border-left:4px solid #667eea;margin:15px 0;color:#718096;font-style:italic;background:rgba(102,126,234,.05);padding:10px 15px;border-radius:0 4px 4px 0}.markdown-preview .md-code{background:#edf2f7;padding:2px 6px;border-radius:4px;font-family:Monaco,Consolas,monospace;font-size:14px}.markdown-preview .md-list{margin:10px 0;padding-left:30px}.markdown-preview .md-paragraph{margin:10px 0}.markdown-preview .md-hr{border:none;border-top:1px solid #e2e8f0;margin:20px 0}.markdown-preview .md-preview-more{color:#718096;font-style:italic;text-align:center;margin:15px 0 5px}.md-paragraph{margin:8px 0}.md-paragraph:first-child{margin-top:0}.md-paragraph:last-child{margin-bottom:0}.md-list{margin:8px 0}.md-list li{margin:3px 0}.md-blockquote{margin:8px 0}.report-format-tabs{display:flex;margin-bottom:15px;border-bottom:1px solid #e2e8f0}.format-tab{padding:10px 20px;border:none;background:0 0;cursor:pointer;font-weight:600;color:#718096;border-bottom:2px solid transparent;transition:.3s}.format-tab:hover{color:#4a5568}.format-tab.active{color:#667eea;border-bottom-color:#667eea}.report-preview-container{margin-top:20px;background:#f7fafc;border-radius:8px;padding:20px;border:1px solid #e2e8f0}.report-preview-content{margin-top:10px;background:#fff;padding:15px;border-radius:5px;border:1px solid #e2e8f0;max-height:500px;overflow-y:auto;white-space:pre-wrap;font-family:monospace}.dark-mode .report-preview-container{background:#2d3748;border-color:#4a5568}.dark-mode .report-preview-content{background:#1a202c;border-color:#4a5568;color:#e2e8f0}.nav-btn{transition:.3s,background 1s ease-out}#pauseButton{min-width:180px;text-align:center}@media (max-width:768px){.container{padding:10px}.nav{flex-wrap:wrap}.entry-item{flex-direction:column;gap:15px}.entry-actions{align-self:flex-end}.report-navigation{flex-wrap:wrap}.week-display{min-width:150px}.settings-grid{grid-template-columns:1fr;gap:20px}.data-management-grid{grid-template-columns:1fr;gap:15px}.time-inputs{grid-template-columns:1fr;gap:10px}.working-days-grid{grid-template-columns:1fr;gap:6px}.card-actions,.notification-buttons{justify-content:center}}body.dark-mode{background:linear-gradient(135deg,#1a1f3a 0,#2d1b4e 50%,#1a0b2e 100%);color:#e2e8f0}.dark-mode .header,.dark-mode .section{background:rgba(45,55,72,.85);backdrop-filter:blur(10px);color:#e2e8f0}.dark-mode .form-group label{color:#a0aec0}.dark-mode .form-group input,.dark-mode .form-group select,.dark-mode .form-group textarea{background:#2d3748;border-color:#4a5568;color:#e2e8f0}.dark-mode .form-group input:focus,.dark-mode .form-group select:focus,.dark-mode .form-group textarea:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.2)}.dark-mode .entry-item{background:#2d3748;border-color:#4a5568}.dark-mode .entry-description{color:#a0aec0}.dark-mode .settings-section{background:#1a202c;border-color:#4a5568}.dark-mode .settings-section h3{color:#e2e8f0}.dark-mode .settings-description{color:#a0aec0}.dark-mode .settings-toggles{border-top-color:#4a5568}.dark-mode .settings-card{background:#2d3748;border-color:#4a5568}.dark-mode .settings-card:hover{border-color:#667eea;box-shadow:0 8px 25px rgba(102,126,234,.25)}.dark-mode .settings-card h3{color:#e2e8f0}.dark-mode .card-description{color:#a0aec0}.dark-mode .report-filters{background:#2d3748}.dark-mode .week-display{background:#2d3748;color:#e2e8f0}.dark-mode .report-summary{background:#2c5282;color:#bee3f8;border-left-color:#63b3ed}.dark-mode .download-section{background:#2f855a;color:#c6f6d5;border-left-color:#68d391}.dark-mode .modal-content{background:#2d3748}.dark-mode .debug-info{background:#1a202c;border-left-color:#667eea}.dark-mode .markdown-preview{background:#1a202c;border-color:#4a5568}.dark-mode .markdown-preview .md-h1,.dark-mode .markdown-preview .md-h2,.dark-mode .markdown-preview .md-h3{color:#e2e8f0}.dark-mode .markdown-preview .md-blockquote{color:#a0aec0;background:rgba(102,126,234,.1);border-left-color:#667eea}.dark-mode .markdown-preview .md-code{background:#2d3748;color:#e2e8f0}.dark-mode .format-tab{color:#a0aec0}.dark-mode .format-tab:hover{color:#e2e8f0}.dark-mode .format-tab.active{color:#667eea;border-bottom-color:#667eea}.dark-mode .preview-format-tabs{border-color:#4a5568}.dark-mode .preview-tab{background:#2d3748;color:#a0aec0}.dark-mode .preview-tab:hover{background:#1a202c;color:#e2e8f0}.dark-mode .preview-tab.active{background:#667eea;color:#fff}.dark-mode .template-editor-tabs{border-bottom-color:#4a5568}.dark-mode .template-tab{color:#a0aec0}.dark-mode .template-tab:hover{color:#e2e8f0;background:#1a202c}.dark-mode .template-tab.active{color:#667eea;border-bottom-color:#667eea;background:#3d4852}.template-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:2000;backdrop-filter:blur(5px)}.template-overlay.active{display:flex;align-items:center;justify-content:center}.template-overlay-content{background:#fff;border-radius:15px;width:95%;max-width:1400px;height:90%;max-height:900px;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.3)}.template-manager-header{padding:20px 30px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;border-radius:15px 15px 0 0}.template-manager-header h2{margin:0;color:#2d3748}.btn-close{background:0 0;border:none;font-size:24px;cursor:pointer;color:#718096;padding:5px 10px;border-radius:5px;transition:.2s}.btn-close:hover{background:#f7fafc;color:#2d3748}.template-manager-body{flex:1;display:grid;grid-template-columns:300px 1fr;min-height:0}.template-list-panel{border-right:1px solid #e2e8f0;padding:20px;display:flex;flex-direction:column;background:#f7fafc}.template-list-panel h3{margin:0 0 15px;color:#2d3748}.template-list{flex:1;overflow-y:auto;margin-bottom:15px}.template-list-item{padding:12px 15px;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:8px;cursor:pointer;transition:.2s;background:#fff}.template-list-item:hover{border-color:#667eea;box-shadow:0 2px 8px rgba(102,126,234,.1)}.template-list-item.active{border-color:#667eea;background:#f0f2ff;box-shadow:0 2px 8px rgba(102,126,234,.2)}.template-list-item.default::after{content:" (Default)";color:#38a169;font-weight:600;font-size:12px}.template-list-item-name{font-weight:600;color:#2d3748;margin-bottom:2px}.template-list-item-desc{font-size:12px;color:#718096}.template-list-item-type{font-size:11px;color:#667eea;text-transform:uppercase;font-weight:600;margin-top:4px}.template-list-actions{display:flex;gap:10px}.template-editor-panel{padding:20px;display:flex;flex-direction:column;min-height:0;overflow:hidden}.template-editor-tabs{display:flex;border-bottom:1px solid #e2e8f0;margin-bottom:20px;margin-top:15px}.template-tab{padding:10px 20px;border:none;background:0 0;cursor:pointer;font-weight:600;color:#718096;border-bottom:2px solid transparent;transition:.3s}.template-tab:hover{color:#4a5568;background:#f7fafc}.template-tab.active{color:#667eea;border-bottom-color:#667eea;background:#f0f2ff}.template-editor-content{flex:1;display:flex;flex-direction:column;min-height:0}.template-editor-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.template-editor-header h3{margin:0;color:#2d3748}.template-editor-actions{display:flex;gap:10px}.template-editor-form{flex:1;overflow-y:auto;display:flex;flex-direction:column}.template-editor-form #templateContent{font-family:Monaco,Consolas,monospace;font-size:13px;resize:vertical;min-height:200px}.template-preview-panel{flex:1;display:flex;flex-direction:column;min-height:0}.template-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.template-preview-controls{display:flex;align-items:center;gap:15px}.preview-format-tabs{display:flex;border:1px solid #e2e8f0;border-radius:6px;overflow:hidden}.preview-tab{padding:6px 12px;border:none;background:#fff;cursor:pointer;font-size:12px;font-weight:600;color:#718096;transition:.2s}.preview-tab:hover{background:#f7fafc;color:#4a5568}.preview-tab.active{background:#667eea;color:#fff}.report-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.report-preview-header h3{margin:0}.template-preview-header h4{margin:0;color:#2d3748}.btn-small{padding:6px 12px;font-size:14px}.template-preview-content{flex:1;background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:15px;overflow-y:auto;font-family:monospace;font-size:12px;white-space:pre-wrap}.template-preview-placeholder{color:#718096;font-style:italic;text-align:center;margin-top:50px}.template-manager-footer{padding:20px 30px;border-top:1px solid #e2e8f0;display:flex;justify-content:flex-end;gap:15px;border-radius:0 0 15px 15px}.template-management-preview{margin-top:15px}.template-preview-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px;margin-bottom:20px}.template-preview-card{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:15px;transition:.2s}.template-preview-card:hover{border-color:#667eea;box-shadow:0 4px 12px rgba(102,126,234,.1)}.template-preview-card.default{border-color:#38a169;background:#f0fff4}.template-preview-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}.template-preview-card-name{font-weight:600;color:#2d3748;margin-bottom:2px}.template-preview-card-type{font-size:11px;color:#667eea;text-transform:uppercase;font-weight:600;background:#e6f3ff;padding:2px 6px;border-radius:3px}.template-preview-card-desc{font-size:13px;color:#718096;margin-bottom:10px}.template-preview-card-sample{background:#f7fafc;border:1px solid #e2e8f0;border-radius:4px;padding:8px;font-family:monospace;font-size:11px;max-height:60px;overflow:hidden;position:relative}.template-preview-card-sample::after{content:"";position:absolute;bottom:0;left:0;right:0;height:20px;background:linear-gradient(transparent,#f7fafc)}.template-actions{display:flex;gap:10px;flex-wrap:wrap}.dark-mode .template-overlay-content{background:#2d3748}.dark-mode .template-manager-header{border-bottom-color:#4a5568}.dark-mode .template-manager-header h2{color:#e2e8f0}.dark-mode .btn-close{color:#a0aec0}.dark-mode .btn-close:hover{background:#1a202c;color:#e2e8f0}.dark-mode .template-list-panel{background:#1a202c;border-right-color:#4a5568}.dark-mode .template-list-panel h3{color:#e2e8f0}.dark-mode .template-list-item{background:#2d3748;border-color:#4a5568}.dark-mode .template-list-item:hover{border-color:#667eea;box-shadow:0 2px 8px rgba(102,126,234,.2)}.dark-mode .template-list-item.active{background:#3d4852}.dark-mode .template-list-item-name{color:#e2e8f0}.dark-mode .template-list-item-desc{color:#a0aec0}.dark-mode .template-editor-header h3,.dark-mode .template-preview-header h4{color:#e2e8f0}.dark-mode .template-preview-content{background:#1a202c;border-color:#4a5568;color:#e2e8f0}.dark-mode .template-manager-footer{border-top-color:#4a5568}.dark-mode .template-preview-card{background:#2d3748;border-color:#4a5568}.dark-mode .template-preview-card-name{color:#e2e8f0}.dark-mode .template-preview-card-desc{color:#a0aec0}.dark-mode .template-preview-card-sample{background:#1a202c;border-color:#4a5568;color:#e2e8f0}.dark-mode .template-preview-card-sample::after{background:linear-gradient(transparent,#1a202c)}.notification-stack{position:fixed;top:20px;right:20px;z-index:9999;pointer-events:none}.notification-toast{background:rgba(45,55,72,.95);backdrop-filter:blur(10px);color:#fff;padding:12px 20px;border-radius:8px;margin-bottom:10px;max-width:350px;box-shadow:0 8px 32px rgba(0,0,0,.3);pointer-events:auto;cursor:pointer;transition:.3s;transform:translateX(400px);opacity:0;animation:.3s forwards slideIn}.notification-toast.notification-success{background:rgba(56,161,105,.95);border-left:4px solid #38a169}.notification-toast.notification-error{background:rgba(229,62,62,.95);border-left:4px solid #e53e3e}.notification-toast.notification-warning{background:rgba(237,137,54,.95);border-left:4px solid #ed8936}.notification-toast.notification-info{background:rgba(49,130,206,.95);border-left:4px solid #3182ce}.notification-toast.removing{animation:.3s forwards slideOut}.notification-toast:hover{transform:translateX(-5px);box-shadow:0 12px 40px rgba(0,0,0,.4)}@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(400px);opacity:0}}@media (max-width:1200px){.template-manager-body{grid-template-columns:250px 1fr}}@media (max-width:768px){.template-overlay-content{width:98%;height:95%}.template-manager-body{grid-template-columns:1fr;grid-template-rows:auto 1fr}.template-list-panel{border-right:none;border-bottom:1px solid #e2e8f0;max-height:200px}.template-preview-panel{height:150px}}</style></head><body><div class="container"><div class="header"><h1>Activity Tracker</h1><p>Track your daily activities with automatic reminders</p><div class="nav"><button class="nav-btn active" onclick="showSection('tracker', event)">Tracker</button> <button class="nav-btn" onclick="showSection('reports', event)">Reports</button> <button class="nav-btn" onclick="showSection('settings', event)">Settings</button> <button id="pauseButton" class="nav-btn" onclick="togglePause()">Pause Alerts</button></div></div><div id="tracker" class="section active"><h2>Activity Entry</h2><form id="activityForm"><div class="form-group"><label for="activity">What are you doing?</label> <input id="activity" required placeholder="e.g., Writing report, Meeting with team" autocomplete="off"></div><div class="form-group"><label for="description">Description (optional)</label> <textarea id="description" rows="3" placeholder="Additional details about this activity"></textarea></div><div class="form-group"><label for="timestamp">Time</label> <input type="datetime-local" id="timestamp" required></div><button type="submit" class="btn btn-primary">Add Entry</button> <button type="button" class="btn btn-secondary" onclick="addCurrentTime()">Use Current Time</button></form><div class="entries-list"><h3>Recent Entries</h3><div id="entriesList"></div></div></div><div id="reports" class="section"><h2>Activity Reports</h2><div class="report-navigation"><button class="btn btn-secondary" onclick="previousWeek()">← Previous Week</button><div class="week-display" id="weekDisplay">Week of ...</div><button class="btn btn-secondary" onclick="nextWeek()">Next Week →</button></div><div class="report-filters"><div class="form-group"><label for="reportStartDate">Start Date</label> <input type="date" id="reportStartDate"></div><div class="form-group"><label for="reportEndDate">End Date</label> <input type="date" id="reportEndDate"></div><div class="form-group form-group-buttons"><button class="btn btn-primary" onclick="generateReport()">Generate Report</button> <button class="btn btn-secondary" onclick="setWeeklyReport()">This Week</button></div></div><div class="download-section"><h3>Download Report</h3><p>Select a template and download the current report.</p><div style="margin-top:15px"><div class="form-group" style="display:inline-block;width:250px;margin-right:15px"><label for="reportTemplate">Report Template</label> <select id="reportTemplate" onchange="tracker.previewReport()"></select></div><button class="btn btn-success" onclick="downloadReport()">Download Report</button></div></div><div id="reportPreviewContainer" class="report-preview-container"><div class="report-preview-header"><h3>Report Preview</h3><div class="preview-format-tabs"><button class="preview-tab active" id="reportPreviewTabRendered" onclick="switchReportPreviewTab('rendered')">Rendered</button> <button class="preview-tab" id="reportPreviewTabSource" onclick="switchReportPreviewTab('source')">Source</button></div></div><div id="reportPreview" class="report-preview-content">Select a date range and generate a report to see a preview.</div></div></div><div id="settings" class="section"><h2>Settings</h2><div class="notification-status" id="notificationStatus"><span class="status-indicator" id="statusIndicator"></span> <span id="statusText">Checking notification status...</span></div><div class="settings-buttons-section"><div class="notification-buttons"><button class="btn btn-primary" onclick="enableNotifications()">Enable Notifications</button> <button class="btn btn-secondary" onclick="testNotification()">Test Notification</button> <button class="btn btn-secondary" onclick="refreshNotificationStatus()">Refresh Status</button> <button class="btn btn-secondary" onclick="testNotificationSound()">Test Sound</button> <button class="btn btn-secondary" onclick="runServiceWorkerTest()">Test Service Worker</button></div></div><div class="settings-grid"><div class="settings-section"><h3>Notification Settings</h3><div class="form-group"><label for="notificationInterval">Reminder Interval</label> <select id="notificationInterval"><option value="1">1 minute</option><option value="2">2 minutes</option><option value="5">5 minutes</option><option value="15">15 minutes</option><option value="30">30 minutes</option><option value="60" selected="selected">1 hour</option><option value="90">1.5 hours</option><option value="120">2 hours</option></select></div><div class="form-group"><label for="pauseDuration">Auto-resume alerts after</label> <select id="pauseDuration"><option value="15">15 minutes</option><option value="60">1 hour</option><option value="240">4 hours</option><option value="1440">24 hours</option><option value="-1">Never</option></select></div><div class="form-group"><label for="notificationSoundType">Notification Sound</label> <select id="notificationSoundType"><option value="classic">Classic Bloop</option><option value="gentle">Gentle Chime</option><option value="urgent">Urgent Ping</option><option value="digital">Digital Beep</option><option value="nature">Nature Drop</option><option value="mechanical">Mechanical Click</option><option value="spacey">Spacey Wobble</option><option value="corporate">Corporate Ding</option></select></div><div class="settings-toggles"><div class="checkbox-group"><input type="checkbox" id="muteNotificationSound"> <label for="muteNotificationSound">Mute notification sound</label></div><div class="checkbox-group"><input type="checkbox" id="darkMode"> <label for="darkMode">Enable dark mode</label></div></div></div><div class="settings-section"><h3>Working Hours</h3><p class="settings-description">Set your active working hours for notifications</p><div class="time-inputs"><div class="form-group"><label for="startTime">Start Time</label> <input type="time" id="startTime" value="08:00"></div><div class="form-group"><label for="endTime">End Time</label> <input type="time" id="endTime" value="18:00"></div></div></div><div class="settings-section"><h3>Working Days</h3><p class="settings-description">Choose which days to receive notifications</p><div class="working-days-grid"><div class="checkbox-group"><input type="checkbox" id="monday" checked="checked"> <label for="monday">Monday</label></div><div class="checkbox-group"><input type="checkbox" id="tuesday" checked="checked"> <label for="tuesday">Tuesday</label></div><div class="checkbox-group"><input type="checkbox" id="wednesday" checked="checked"> <label for="wednesday">Wednesday</label></div><div class="checkbox-group"><input type="checkbox" id="thursday" checked="checked"> <label for="thursday">Thursday</label></div><div class="checkbox-group"><input type="checkbox" id="friday" checked="checked"> <label for="friday">Friday</label></div><div class="checkbox-group"><input type="checkbox" id="saturday"> <label for="saturday">Saturday</label></div><div class="checkbox-group"><input type="checkbox" id="sunday"> <label for="sunday">Sunday</label></div></div></div></div><div class="data-management-section"><div class="data-management-grid"><div class="settings-card"><h3>Report Templates</h3><p class="card-description">Manage templates for report generation</p><div class="card-actions"><button class="btn btn-primary" onclick="openTemplateManager()">Manage Templates</button> <button class="btn btn-secondary" onclick="resetReportTemplates()">Reset to Default</button></div></div><div class="settings-card"><h3>Database Backup</h3><p class="card-description">Export or import your activity data</p><div class="card-actions"><button class="btn btn-primary" onclick="exportDatabase()">Export Database</button> <button class="btn btn-secondary" onclick="importDatabase()">Import Database</button> <input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImportFile(event)"></div></div></div></div><div class="about-section"><div class="debug-info" id="debugInfo"><strong>About:</strong><br><span id="debugText">Loading...</span></div></div><button class="btn btn-primary" onclick="saveSettings()">Save Settings</button> <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button></div></div><div id="notificationStack" class="notification-stack"></div><div id="editModal" class="modal"><div class="modal-content"><h3>Edit Entry</h3><form id="editForm"><input type="hidden" id="editId"><div class="form-group"><label for="editActivity">Activity</label> <input id="editActivity" required></div><div class="form-group"><label for="editDescription">Description</label> <textarea id="editDescription" rows="3"></textarea></div><div class="form-group"><label for="editTimestamp">Time</label> <input type="datetime-local" id="editTimestamp" required></div><button type="submit" class="btn btn-primary">Update Entry</button> <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button></form></div></div><div id="templateManagerOverlay" class="template-overlay"><div class="template-overlay-content"><div class="template-manager-header"><h2>Template Manager</h2><button class="btn-close" onclick="closeTemplateManager()">&times;</button></div><div class="template-manager-body"><div class="template-list-panel"><h3>Templates</h3><div class="template-list" id="templateList"></div><div class="template-list-actions"><button class="btn btn-primary" onclick="addNewTemplate()">Add Template</button> <button class="btn btn-secondary" onclick="resetToDefaults()">Reset All</button></div></div><div class="template-editor-panel"><div class="template-editor-header"><h3 id="templateEditorTitle">Select a template to edit</h3><div class="template-editor-actions" id="templateEditorActions" style="display:none"><button class="btn btn-success" onclick="saveCurrentTemplate()">Save</button> <button class="btn btn-danger" onclick="deleteCurrentTemplate()">Delete</button> <button class="btn btn-secondary" onclick="duplicateCurrentTemplate()">Duplicate</button></div></div><div class="template-editor-tabs" id="templateEditorTabs" style="display:none"><button class="template-tab active" id="tabEditor" onclick="switchTemplateTab('editor')">Editor</button> <button class="template-tab" id="tabPreview" onclick="switchTemplateTab('preview')">Preview</button></div><div class="template-editor-content"><div class="template-editor-form" id="templateEditorForm" style="display:none"><div class="form-group"><label for="templateName">Template Name</label> <input id="templateName" placeholder="e.g., My Custom Template"></div><div class="form-group"><label for="templateDescription">Description</label> <input id="templateDescription" placeholder="Brief description of the template"></div><div class="form-group"><label for="templateType">Output Type</label> <select id="templateType"><option value="html">HTML</option><option value="markdown">Markdown</option><option value="csv">CSV</option><option value="text">Plain Text</option></select></div><div class="form-group"><label for="templateContent">Template Content</label> <textarea id="templateContent" rows="20" placeholder="Enter your template content here..."></textarea></div><div class="checkbox-group"><input type="checkbox" id="templateIsDefault"> <label for="templateIsDefault">Set as default template</label></div></div><div class="template-preview-panel" id="templatePreviewPanel" style="display:none"><div class="template-preview-header"><h4>Preview</h4><div class="template-preview-controls"><div class="preview-format-tabs"><button class="preview-tab active" id="previewTabRendered" onclick="switchPreviewTab('rendered')">Rendered</button> <button class="preview-tab" id="previewTabSource" onclick="switchPreviewTab('source')">Source</button></div><button class="btn btn-secondary btn-small" onclick="refreshTemplatePreview()">Refresh</button></div></div><div class="template-preview-content" id="templatePreviewContent"><p class="template-preview-placeholder">Select a template to see preview</p></div></div></div></div></div><div class="template-manager-footer"><button class="btn btn-primary" onclick="saveAllTemplates()">Save All Changes</button> <button class="btn btn-secondary" onclick="closeTemplateManager()">Close</button></div></div></div><script>const APP_VERSION="2025.07.31.14";function formatDateTime(e){return new Date(e).toLocaleString("en-GB",{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function formatDate(e){return e.toLocaleDateString("en-GB",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}function formatTime(e){return new Date(e).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function showNotification(e,t="info",n=3e3){const i=document.createElement("div");i.style.cssText=`\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        padding: 15px 20px;\n        border-radius: 8px;\n        color: white;\n        font-weight: 600;\n        z-index: 10000;\n        background: ${"success"===t?"#48bb78":"error"===t?"#f56565":"#667eea"};\n        box-shadow: 0 4px 15px rgba(0,0,0,0.2);\n        animation: slideIn 0.3s ease-out;\n    `;const a=document.createElement("style");a.textContent="\n        @keyframes slideIn {\n            from {\n                transform: translateX(100%);\n                opacity: 0;\n            }\n            to {\n                transform: translateX(0);\n                opacity: 1;\n            }\n        }\n        @keyframes slideOut {\n            from {\n                transform: translateX(0);\n                opacity: 1;\n            }\n            to {\n                transform: translateX(100%);\n                opacity: 0;\n            }\n        }\n    ",document.head.appendChild(a),i.textContent=e,document.body.appendChild(i),setTimeout(()=>{i.style.animation="slideOut 0.3s ease-in",setTimeout(()=>{i.parentNode&&i.remove()},300)},n)}function downloadFile(e,t,n){const i=new Blob([e],{type:n}),a=URL.createObjectURL(i),r=document.createElement("a");r.href=a,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}function getCurrentTimeForInput(){const e=new Date;return e.setMinutes(e.getMinutes()-e.getTimezoneOffset()),e.toISOString().slice(0,16)}function escapeCsv(e){return e?e.includes(",")||e.includes('"')||e.includes("\n")?`"${e.replace(/"/g,'""')}"`:e:""}function generateId(){return Date.now().toString()+Math.random().toString(36).substr(2,9)}function isValidDate(e){const t=new Date(e);return t instanceof Date&&!isNaN(t)}function getWeekStart(e){const t=new Date(e),n=e.getDay(),i=0===n?-6:1-n;return t.setDate(e.getDate()+i),t.setHours(0,0,0,0),t}function getWeekEnd(e){const t=new Date(getWeekStart(e));return t.setDate(t.getDate()+6),t.setHours(23,59,59,999),t}function deepClone(e){if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return new Date(e.getTime());if(e instanceof Array)return e.map(e=>deepClone(e));if("object"==typeof e){const t={};return Object.keys(e).forEach(n=>{t[n]=deepClone(e[n])}),t}}class SoundManager{constructor(){this.audioContext=null,this.soundTypes={classic:"Classic Bloop",gentle:"Gentle Chime",urgent:"Urgent Ping",digital:"Digital Beep",nature:"Nature Drop",mechanical:"Mechanical Click",spacey:"Spacey Wobble",corporate:"Corporate Ding"},this.initAudioContext()}initAudioContext(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(e){console.warn("Web Audio API not supported:",e),this.audioContext=null}}getSoundTypes(){return this.soundTypes}playSound(e="classic",t=!1){if(this.audioContext&&!t)try{"suspended"===this.audioContext.state&&this.audioContext.resume();const t=this.audioContext.currentTime;switch(e){case"classic":default:this.playClassicBloop(t);break;case"gentle":this.playGentleChime(t);break;case"urgent":this.playUrgentPing(t);break;case"digital":this.playDigitalBeep(t);break;case"nature":this.playNatureDrop(t);break;case"mechanical":this.playMechanicalClick(t);break;case"spacey":this.playSpaceyWobble(t);break;case"corporate":this.playCorporateDing(t)}}catch(e){console.warn("Error playing notification sound:",e)}}playClassicBloop(e){const t=this.audioContext.createOscillator(),n=this.audioContext.createGain();t.connect(n),n.connect(this.audioContext.destination),t.type="sine",t.frequency.setValueAtTime(400,e),t.frequency.exponentialRampToValueAtTime(600,e+.1),n.gain.setValueAtTime(0,e),n.gain.linearRampToValueAtTime(.3,e+.05),n.gain.exponentialRampToValueAtTime(.01,e+.3),t.start(e),t.stop(e+.3)}playGentleChime(e){const t=this.audioContext.createOscillator(),n=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),n.connect(i),i.connect(this.audioContext.destination),t.type="sine",n.type="sine",t.frequency.setValueAtTime(523.25,e),n.frequency.setValueAtTime(659.25,e),i.gain.setValueAtTime(0,e),i.gain.linearRampToValueAtTime(.2,e+.05),i.gain.exponentialRampToValueAtTime(.01,e+1),t.start(e),n.start(e),t.stop(e+1),n.stop(e+1)}playUrgentPing(e){const t=this.audioContext.createOscillator(),n=this.audioContext.createGain();t.connect(n),n.connect(this.audioContext.destination),t.type="triangle",t.frequency.setValueAtTime(800,e),t.frequency.exponentialRampToValueAtTime(1200,e+.05),t.frequency.exponentialRampToValueAtTime(800,e+.1),n.gain.setValueAtTime(0,e),n.gain.linearRampToValueAtTime(.4,e+.02),n.gain.exponentialRampToValueAtTime(.01,e+.15),t.start(e),t.stop(e+.15)}playDigitalBeep(e){const t=this.audioContext.createOscillator(),n=this.audioContext.createGain();t.connect(n),n.connect(this.audioContext.destination),t.type="square",t.frequency.setValueAtTime(1e3,e),n.gain.setValueAtTime(0,e),n.gain.linearRampToValueAtTime(.3,e+.01),n.gain.linearRampToValueAtTime(.3,e+.05),n.gain.linearRampToValueAtTime(0,e+.06),t.start(e),t.stop(e+.06)}playNatureDrop(e){const t=this.audioContext.createOscillator(),n=this.audioContext.createGain(),i=this.audioContext.createBiquadFilter();t.connect(i),i.connect(n),n.connect(this.audioContext.destination),t.type="sine",t.frequency.setValueAtTime(1200,e),t.frequency.exponentialRampToValueAtTime(200,e+.8),i.type="lowpass",i.frequency.setValueAtTime(2e3,e),i.frequency.exponentialRampToValueAtTime(300,e+.8),n.gain.setValueAtTime(0,e),n.gain.linearRampToValueAtTime(.25,e+.05),n.gain.exponentialRampToValueAtTime(.01,e+.8),t.start(e),t.stop(e+.8)}playMechanicalClick(e){const t=this.audioContext.createOscillator(),n=this.audioContext.createGain(),i=this.audioContext.createBiquadFilter();t.connect(i),i.connect(n),n.connect(this.audioContext.destination),t.type="sawtooth",t.frequency.setValueAtTime(150,e),i.type="highpass",i.frequency.setValueAtTime(100,e),n.gain.setValueAtTime(0,e),n.gain.linearRampToValueAtTime(.5,e+.005),n.gain.linearRampToValueAtTime(0,e+.05),t.start(e),t.stop(e+.05)}playSpaceyWobble(e){const t=this.audioContext.createOscillator(),n=this.audioContext.createOscillator(),i=this.audioContext.createGain(),a=this.audioContext.createGain();n.connect(i),i.connect(t.frequency),t.connect(a),a.connect(this.audioContext.destination),t.type="sine",t.frequency.setValueAtTime(300,e),n.type="sine",n.frequency.setValueAtTime(6,e),i.gain.setValueAtTime(50,e),a.gain.setValueAtTime(0,e),a.gain.linearRampToValueAtTime(.3,e+.1),a.gain.exponentialRampToValueAtTime(.01,e+1.2),n.start(e),t.start(e),n.stop(e+1.2),t.stop(e+1.2)}playCorporateDing(e){const t=this.audioContext.createOscillator(),n=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),n.connect(i),i.connect(this.audioContext.destination),t.type="sine",n.type="sine",t.frequency.setValueAtTime(880,e),n.frequency.setValueAtTime(1108.73,e),i.gain.setValueAtTime(0,e),i.gain.linearRampToValueAtTime(.25,e+.02),i.gain.exponentialRampToValueAtTime(.01,e+.5),t.start(e),n.start(e),t.stop(e+.5),n.stop(e+.5)}testSound(e,t=!1){this.playSound(e,t)}}"undefined"!=typeof window&&(window.SoundManager=SoundManager);class PauseManager{constructor(e){this.tracker=e,this.countdownInterval=null,this.pauseButton=null,this.originalButtonText="Pause Alerts",this.init()}init(){this.pauseButton=document.getElementById("pauseButton"),this.pauseButton&&this.updatePauseButtonDisplay()}startPause(e){this.stopCountdown(),-1===e?(this.tracker.settings.notificationsPausedUntil=1/0,this.updatePauseButtonForever()):(this.tracker.settings.notificationsPausedUntil=(new Date).getTime()+60*e*1e3,this.startCountdown()),this.tracker.saveSettings()}resume(){this.stopCountdown(),this.tracker.settings.notificationsPausedUntil=null,this.updatePauseButtonNormal(),this.tracker.saveSettings()}startCountdown(){this.countdownInterval&&clearInterval(this.countdownInterval),this.updateCountdownDisplay(),this.countdownInterval=setInterval(()=>{this.updateCountdownDisplay()},1e3)}stopCountdown(){this.countdownInterval&&(clearInterval(this.countdownInterval),this.countdownInterval=null)}updateCountdownDisplay(){if(!this.pauseButton||!this.tracker.settings.notificationsPausedUntil)return void this.updatePauseButtonNormal();const e=(new Date).getTime(),t=this.tracker.settings.notificationsPausedUntil;if(t===1/0)return void this.updatePauseButtonForever();const n=t-e;if(n<=0)return this.resume(),void showNotification("Notifications automatically resumed","success");const i=Math.floor(n/1e3),a=Math.floor(i/3600),r=Math.floor(i%3600/60),o=i%60;let s;s=a>0?`${a}h ${r}m ${o}s`:r>0?`${r}m ${o}s`:`${o}s`,this.pauseButton.textContent=`Resume (${s})`;const c=60*this.tracker.settings.pauseDuration*1e3,l=c-n,d=Math.max(0,Math.min(100,l/c*100));this.applyDrainingEffect(d)}applyDrainingEffect(e){const t="rgba(229, 62, 62, 0.3)",n="#e53e3e";this.pauseButton.style.background=`linear-gradient(to left, ${t} 0%, ${t} ${e}%, ${n} ${e}%, ${n} 100%)`,this.pauseButton.style.transition="background 1s ease-out",this.pauseButton.style.animation=e>90?"pulse 1s infinite":"none"}updatePauseButtonForever(){this.pauseButton.textContent="Resume (Paused Forever)",this.pauseButton.style.background="#e53e3e",this.pauseButton.style.animation="none",this.pauseButton.style.transition=""}updatePauseButtonNormal(){this.pauseButton.textContent=this.originalButtonText,this.pauseButton.style.background="",this.pauseButton.style.animation="none",this.pauseButton.style.transition=""}updatePauseButtonDisplay(){this.pauseButton&&(this.tracker.settings.notificationsPausedUntil?this.tracker.settings.notificationsPausedUntil===1/0?this.updatePauseButtonForever():this.startCountdown():this.updatePauseButtonNormal())}isPaused(){return!!this.tracker.settings.notificationsPausedUntil&&(this.tracker.settings.notificationsPausedUntil===1/0||(new Date).getTime()<this.tracker.settings.notificationsPausedUntil)}getRemainingTime(){if(!this.tracker.settings.notificationsPausedUntil)return 0;if(this.tracker.settings.notificationsPausedUntil===1/0)return-1;const e=(new Date).getTime(),t=this.tracker.settings.notificationsPausedUntil-e;return Math.max(0,t)}destroy(){this.stopCountdown()}}"undefined"!=typeof window&&(window.PauseManager=PauseManager);class MarkdownRenderer{constructor(){this.rules=[{pattern:/^### (.*$)/gim,replacement:"<h3>$1</h3>"},{pattern:/^## (.*$)/gim,replacement:"<h2>$1</h2>"},{pattern:/^# (.*$)/gim,replacement:"<h1>$1</h1>"},{pattern:/\*\*(.*)\*\*/gim,replacement:"<strong>$1</strong>"},{pattern:/\*(.*)\*/gim,replacement:"<em>$1</em>"},{pattern:/`(.*)`/gim,replacement:"<code>$1</code>"},{pattern:/\[([^\]]*)\]\(([^\)]*)\)/gim,replacement:'<a href="$2">$1</a>'},{pattern:/^---\s*$/gim,replacement:"<hr>"},{pattern:/^> (.*)$/gim,replacement:"<blockquote>$1</blockquote>"},{pattern:/^\- (.*)$/gim,replacement:"<li>$1</li>"}]}render(e,t=!1){if(!e||"string"!=typeof e)return"";let n=e.trim();return this.rules.forEach(e=>{n=n.replace(e.pattern,e.replacement)}),n=n.replace(/\n\s*\n/gim,"</p><p>"),n=n.replace(/\n(?![<\/])/gim,"<br>"),t&&n.match(/^<(h[1-6]|ul|ol|blockquote|hr)/)||(n="<p>"+n+"</p>"),n=n.replace(/<p>\s*<\/p>/gim,""),n=n.replace(/<p><h/gim,"<h"),n=n.replace(/<\/h([1-6])><\/p>/gim,"</h$1>"),n=n.replace(/<p><hr><\/p>/gim,"<hr>"),n=n.replace(/<p><blockquote>/gim,"<blockquote>"),n=n.replace(/<\/blockquote><\/p>/gim,"</blockquote>"),n=n.replace(/<p><ul>/gim,"<ul>"),n=n.replace(/<\/ul><\/p>/gim,"</ul>"),n=this.renderLists(n),n=n.replace(/<br>\s*<\/li>/gim,"</li>"),n=n.replace(/<li><br>/gim,"<li>"),n=n.replace(/<\/ul><br>/gim,"</ul>"),n=n.replace(/<br><ul>/gim,"<ul>"),n}renderLists(e){return(e=(e=(e=(e=(e=(e=e.replace(/(<li>.*?<\/li>)(\s*(<br>)?\s*<li>.*?<\/li>)*/gim,e=>(e.replace(/<br>\s*(?=<li>)/gim,""),"<ul>"+e+"</ul>"))).replace(/<p><ul>/gim,"<ul>")).replace(/<\/ul><\/p>/gim,"</ul>")).replace(/<p><li>/gim,"<li>")).replace(/<\/li><\/p>/gim,"</li>")).replace(/<br>\s*<ul>/gim,"<ul>")).replace(/<\/ul>\s*<br>/gim,"</ul>")}renderInline(e){return this.render(e,!0)}renderWithClasses(e,t=!1){let n=this.render(e,t);return n=n.replace(/<h1>/gim,'<h1 class="md-h1">'),n=n.replace(/<h2>/gim,'<h2 class="md-h2">'),n=n.replace(/<h3>/gim,'<h3 class="md-h3">'),n=n.replace(/<blockquote>/gim,'<blockquote class="md-blockquote">'),n=n.replace(/<code>/gim,'<code class="md-code">'),n=n.replace(/<ul>/gim,'<ul class="md-list">'),n=n.replace(/<p>/gim,'<p class="md-paragraph">'),n=n.replace(/<hr>/gim,'<hr class="md-hr">'),n}renderInlineWithClasses(e){return this.renderWithClasses(e,!0)}preview(e,t=10){if(!e)return"";const n=e.split("\n").slice(0,t),i=n.join("\n");return n.length>=t&&e.split("\n").length>t?this.renderWithClasses(i)+'<p class="md-preview-more">...</p>':this.renderWithClasses(i)}}"undefined"!=typeof window&&(window.MarkdownRenderer=MarkdownRenderer);class TemplatingEngine{constructor(){this.formatters={date:(e,t="dd/mm/yyyy")=>this.formatDate(e,t),time:e=>{if(!e)return"--:--";let t=e instanceof Date?e:new Date(e);return isNaN(t.getTime())?"--:--":t.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})},datetime:e=>new Date(e).toLocaleString("en-GB"),uppercase:e=>String(e).toUpperCase(),lowercase:e=>String(e).toLowerCase(),capitalize:e=>String(e).charAt(0).toUpperCase()+String(e).slice(1),escapeHtml:e=>this.escapeHtml(e),escapeCsv:e=>this.escapeCsv(e),nl2br:e=>String(e).replace(/\n/g,"<br>"),stripLinebreaks:e=>String(e).replace(/(\r\n|\n|\r)/gm," "),duration:e=>this.formatDuration(e),markdown:e=>window.MarkdownRenderer?(new window.MarkdownRenderer).renderInlineWithClasses(String(e)):this.escapeHtml(e)}}render(e,t){try{const n=this.tokenize(e),i=this.parse(n);return this.evaluate(i,t)}catch(e){return console.error("❌ Template render error:",e),`Template Error: ${e.message}`}}tokenize(e){const t=[];let n=0;for(;n<e.length;){const i=e.indexOf("{{",n);if(-1===i){n<e.length&&t.push({type:"TEXT",value:e.substring(n)});break}i>n&&t.push({type:"TEXT",value:e.substring(n,i)});const a=e.indexOf("}}",i);if(-1===a)throw new Error("Unclosed template expression at position "+i);const r=e.substring(i+2,a).trim(),o=this.parseExpression(r);t.push(o),n=a+2}return t}parseExpression(e){if(e.startsWith("#each ")){const t=e.match(/^#each\s+(\w+)\s*=\s*([\w.]+)$/);if(!t)throw new Error("Invalid each expression: "+e);return{type:"EACH_START",itemVar:t[1],arrayPath:t[2]}}if("/each"===e)return{type:"EACH_END"};if(e.startsWith("#if "))return{type:"IF_START",condition:e.substring(4).trim()};if("else"===e)return{type:"ELSE"};if("/if"===e)return{type:"IF_END"};const t=e.split("|").map(e=>e.trim());return{type:"VARIABLE",path:t[0],formatters:t.slice(1)}}parse(e){const t=[];let n=0;for(;n<e.length;){const i=this.parseNode(e,n);i?(t.push(i.node),n=i.nextIndex):n++}return t}parseNode(e,t){if(t>=e.length)return null;const n=e[t];switch(n.type){case"TEXT":return{node:{type:"text",value:n.value},nextIndex:t+1};case"VARIABLE":return{node:{type:"variable",path:n.path,formatters:n.formatters},nextIndex:t+1};case"EACH_START":return this.parseEachLoop(e,t);case"IF_START":return this.parseIfStatement(e,t);case"EACH_END":case"IF_END":case"ELSE":return console.warn("⚠️ Orphaned token:",n.type,"at index",t),null;default:throw new Error("Unknown token type: "+n.type)}}parseEachLoop(e,t){const n=e[t],i=[];let a=t+1,r=1;for(;a<e.length&&r>0;){const t=e[a];if("EACH_START"===t.type){const t=this.parseEachLoop(e,a);i.push(t.node),a=t.nextIndex}else if("EACH_END"===t.type){if(r--,0===r)break;console.error(`❌ Unexpected EACH_END at depth ${r} for ${n.itemVar}`),a++}else{const t=this.parseNode(e,a);t?(i.push(t.node),a=t.nextIndex):a++}}if(r>0)throw console.error(`❌ Unclosed each loop for ${n.itemVar}, depth: ${r}, current: ${a}, tokens.length: ${e.length}`),console.error("Remaining tokens:",e.slice(a).map(e=>`${e.type}: ${JSON.stringify(e.value||e.path)}`)),new Error(`Unclosed each loop for ${n.itemVar}`);return{node:{type:"each",itemVar:n.itemVar,arrayPath:n.arrayPath,children:i},nextIndex:a+1}}parseIfStatement(e,t){const n=e[t],i=[],a=[];let r=t+1,o=1,s=!1;for(;r<e.length&&o>0;){const t=e[r];if("IF_START"===t.type){o++;const t=this.parseIfStatement(e,r);s?a.push(t.node):i.push(t.node),r=t.nextIndex}else if("IF_END"===t.type){if(o--,0===o)break;r++}else if("ELSE"===t.type&&1===o)s=!0,r++;else{const t=this.parseNode(e,r);t?(s?a.push(t.node):i.push(t.node),r=t.nextIndex):r++}}return{node:{type:"if",condition:n.condition,ifChildren:i,elseChildren:a},nextIndex:r+1}}evaluate(e,t,n=0){return"  ".repeat(n),e.map(e=>this.evaluateNode(e,t,n)).join("")}evaluateNode(e,t,n=0){const i="  ".repeat(n);switch(e.type){case"text":return e.value;case"variable":let a=this.getValue(t,e.path);for(const t of e.formatters||[])a=this.applyFormatter(a,t);return null!=a?String(a):"";case"each":const r=this.getValue(t,e.arrayPath);return Array.isArray(r)?r.map((i,a)=>{const o={...t,[e.itemVar]:i,index:a,first:0===a,last:a===r.length-1};return this.evaluate(e.children,o,n+1)}).join(""):(console.warn(`${i}⚠️ Not an array:`,r),"");case"if":const o=this.getValue(t,e.condition),s=this.isTruthy(o)?e.ifChildren:e.elseChildren;return this.evaluate(s,t,n+1);default:throw new Error("Unknown node type: "+e.type)}}getValue(e,t){if(!t||!e)return;const n=t.split(".");let i=e;for(const e of n){if(null==i)return;i=i[e]}return i}isTruthy(e){return null!=e&&("boolean"==typeof e?e:"number"==typeof e?0!==e:"string"==typeof e||Array.isArray(e)?e.length>0:"object"==typeof e?Object.keys(e).length>0:!!e)}applyFormatter(e,t){const n=t.match(/^(\w+)(?:\s*\(\s*['"]?(.*?)['"]?\s*\))?$/);if(!n)return e;const[,i,a]=n;if(!this.formatters[i])return console.warn("⚠️ Unknown formatter:",i),e;try{return void 0!==a?this.formatters[i](e,a):this.formatters[i](e)}catch(t){return console.warn("❌ Formatter error:",i,t),e}}formatDate(e,t){const n=new Date(e);if(isNaN(n.getTime()))return"Invalid Date";const i=n.getFullYear(),a=n.getMonth(),r=n.getDate();let o=t.replace(/mmm/g,["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a]);return o=o.replace(/yyyy/g,i).replace(/mm/g,String(a+1).padStart(2,"0")).replace(/dd/g,String(r).padStart(2,"0")),o}formatDuration(e){if(isNaN(e)||e<0)return"";const t=Math.floor(e/60),n=e%60;let i="";return t>0&&(i+=`${t}h `),n>0&&(i+=`${n}m`),i.trim()}escapeHtml(e){return null==e?"":String(e).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]))}escapeCsv(e){if(null==e)return"";let t=String(e);return t.includes(",")||t.includes('"')||t.includes("\n")?`"${t.replace(/"/g,'""')}"`:t}}window.TemplatingEngine=TemplatingEngine,window.ReportTemplates={"detailed-html":{name:"Detailed Report (HTML)",description:"A comprehensive HTML report with timings and full descriptions.",type:"html",template:'<!DOCTYPE html>\n<html lang="en-GB">\n<head>\n    <meta charset="UTF-8">\n    <title>Activity Report: {{ report.startDate | date(\'dd/mm/yyyy\') }} - {{ report.endDate | date(\'dd/mm/yyyy\') }}</title>\n    <style>\n        body { font-family: sans-serif; line-height: 1.5; color: #333; }\n        .report-container { max-width: 800px; margin: 20px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }\n        .report-header { text-align: center; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 20px; }\n        .report-summary { background: #f0f2ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; }\n        .day-group { margin-bottom: 20px; }\n        .day-header { font-size: 1.2em; font-weight: bold; color: #667eea; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; }\n        .entry { margin-bottom: 10px; padding-left: 15px; border-left: 3px solid #ccc; }\n        .entry-time { font-weight: bold; }\n        .entry-activity { font-size: 1.1em; }\n        .entry-description { color: #555; font-style: italic; }\n        .duration { font-size: 0.9em; color: #888; }\n    </style>\n</head>\n<body>\n    <div class="report-container">\n        <div class="report-header">\n            <h1>Activity Report</h1>\n            <p>{{ report.startDate | date(\'dd mmm yyyy\') }} to {{ report.endDate | date(\'dd mmm yyyy\') }}</p>\n        </div>\n        <div class="report-summary">\n            <h3>Report Summary</h3>\n            <p><strong>Total Entries:</strong> {{ report.totalEntries }}</p>\n            <p><strong>Total Duration:</strong> {{ report.totalDuration | duration }}</p>\n            <p><strong>Active Days:</strong> {{ report.activeDays }}</p>\n        </div>\n        \n        {{#each day = days}}\n        <div class="day-group">\n            <h2 class="day-header">{{ day.date }} ({{ day.entries.length }} entries, {{ day.totalDuration | duration }})</h2>\n            {{#each entry = day.entries}}\n            <div class="entry">\n                <p><span class="entry-time">{{ entry.timestamp | time }}</span>: <span class="entry-activity">{{ entry.activity | escapeHtml }}</span></p>\n                {{#if entry.description}}\n                <div class="entry-description">{{ entry.description | markdown }}</div>\n                {{/if}}\n                <p class="duration">Duration: {{ entry.duration | duration }}</p>\n            </div>\n            {{/each}}\n        </div>\n        {{/each}}\n    </div>\n</body>\n</html>'},"summary-markdown":{name:"Summary (Markdown)",description:"A summary report in Markdown, suitable for pasting into documents.",type:"markdown",template:"# Activity Report\n\n**Period:** {{ report.startDate | date('dd mmm yyyy') }} to {{ report.endDate | date('dd mmm yyyy') }}\n\n## Summary\n- **Total Entries:** {{ report.totalEntries }}\n- **Total Duration:** {{ report.totalDuration | duration }}\n- **Active Days:** {{ report.activeDays }}\n\n---\n\n{{#each day = days}}\n## {{ day.date }} (Total: {{ day.totalDuration | duration }})\n{{#each entry = day.entries}}\n- **{{ entry.timestamp | time }} ({{ entry.duration | duration }})**: {{ entry.activity }}\n{{/each}}\n{{/each}}"},"basic-csv":{name:"Basic Export (CSV)",description:"A simple CSV file with core activity data.",type:"csv",template:"Date,Time,Activity,Description\n{{#each entry = entries}}{{ entry.timestamp | date('yyyy-mm-dd') }},{{ entry.timestamp | time }},{{ entry.activity | escapeCsv | stripLinebreaks }},{{ entry.description | escapeCsv | stripLinebreaks }}\n{{/each}}"},"timed-csv":{name:"Timed Export (CSV)",description:"A detailed CSV file including calculated durations.",type:"csv",template:'Date,StartTime,EndTime,DurationMinutes,Activity,Description\n{{#each entry = entries}}{{ entry.timestamp | date(\'yyyy-mm-dd\') }},{{ entry.timestamp | time }},{{ entry.endTime | time }},{{ entry.duration }},"{{ entry.activity | escapeCsv | stripLinebreaks }}","{{ entry.description | escapeCsv | stripLinebreaks }}"\n{{/each}}'}};class ActivityTracker{constructor(){let e=[];try{const t=JSON.parse(localStorage.getItem("activityEntries"));Array.isArray(t)&&(e=t.filter(e=>e&&"object"==typeof e&&e.timestamp))}catch(e){console.error("Error parsing activity entries from localStorage",e),localStorage.removeItem("activityEntries")}this.entries=e,this.settings={notificationInterval:60,startTime:"08:00",endTime:"18:00",workingDays:{monday:!0,tuesday:!0,wednesday:!0,thursday:!0,friday:!0,saturday:!1,sunday:!1},pauseDuration:60,notificationsPausedUntil:null,notificationsEnabled:!0,muteNotificationSound:!1,notificationSoundType:"classic",darkMode:!1,...JSON.parse(localStorage.getItem("activitySettings")||"{}")},this.notificationTimer=null,this.currentReportEntries=[],this.currentWeekStart=null,this.soundManager=null,this.pauseManager=null,this.init()}init(){this.loadSettings(),this.initMarkdownRenderer(),this.initReportTemplates(),this.loadReportTemplatesIntoEditor(),this.initTemplatePreviewGrid(),this.displayEntries(),this.updateNotificationStatus(),this.updateDebugInfo(),this.updatePauseButtonState(),this.startNotificationTimer(),this.setWeeklyReport(),this.initSoundManager(),this.initPauseManager(),this.attachEventListeners(),this.setCurrentTime(),document.getElementById("activity").focus(),"file:"===window.location.protocol&&console.warn("Running from local file - notifications may have limitations")}getReportTemplates(){const e=localStorage.getItem("reportTemplates");if(e)try{return JSON.parse(e)}catch(e){return console.error("Error parsing custom report templates from localStorage",e),window.ReportTemplates||{}}return window.ReportTemplates||{}}loadReportTemplatesIntoEditor(){const e=document.getElementById("report-templates-editor");if(!e)return;const t=this.getReportTemplates();e.innerHTML=Object.keys(t).map(e=>`\n            <div class="template-group">\n                <label for="template-${e}">${t[e].name}</label>\n                <textarea id="template-${e}" data-key="${e}">${escapeHtml(t[e].template)}</textarea>\n            </div>\n        `).join("")}saveReportTemplates(){const e=document.getElementById("report-templates-editor");if(!e)return;const t=this.getReportTemplates();e.querySelectorAll("textarea").forEach(e=>{const n=e.dataset.key;t[n]&&(t[n].template=e.value)}),localStorage.setItem("reportTemplates",JSON.stringify(t)),showNotification("Report templates saved successfully!","success"),this.initReportTemplates(),this.currentReportData&&this.previewReport()}resetReportTemplates(){confirm("Are you sure you want to reset all report templates to their default values?")&&(localStorage.removeItem("reportTemplates"),this.loadReportTemplatesIntoEditor(),this.initReportTemplates(),this.currentReportData&&this.previewReport(),showNotification("Report templates have been reset to default.","success"))}initMarkdownRenderer(){try{this.markdownRenderer=new MarkdownRenderer}catch(e){console.warn("Markdown Renderer initialization failed:",e)}}initPauseManager(){try{this.pauseManager=new PauseManager(this)}catch(e){console.warn("Pause Manager initialization failed:",e)}}attachEventListeners(){document.getElementById("activityForm").addEventListener("submit",e=>{e.preventDefault(),this.addEntry()}),document.getElementById("editForm").addEventListener("submit",e=>{e.preventDefault(),this.updateEntry()}),this.attachSettingsListeners()}attachSettingsListeners(){["notificationInterval","startTime","endTime","pauseDuration","muteNotificationSound","notificationSoundType","darkMode","monday","tuesday","wednesday","thursday","friday","saturday","sunday"].forEach(e=>{const t=document.getElementById(e);if(t){let e;e="checkbox"===t.type||"select"===t.tagName.toLowerCase()?"change":"input",t.addEventListener(e,()=>{this.autoSaveSettings()})}})}autoSaveSettings(){this.settings.notificationInterval=parseInt(document.getElementById("notificationInterval").value),this.settings.startTime=document.getElementById("startTime").value,this.settings.endTime=document.getElementById("endTime").value,this.settings.pauseDuration=parseInt(document.getElementById("pauseDuration").value),this.settings.muteNotificationSound=document.getElementById("muteNotificationSound").checked,this.settings.notificationSoundType=document.getElementById("notificationSoundType").value,this.settings.darkMode=document.getElementById("darkMode").checked,["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].forEach(e=>{this.settings.workingDays[e]=document.getElementById(e).checked}),this.applyTheme(),this.saveSettings(),this.settings.notificationsEnabled&&this.startNotificationTimer(),this.updateDebugInfo(),showNotification("Settings saved automatically","success",1500)}initSoundManager(){try{this.soundManager=new SoundManager}catch(e){console.warn("Sound Manager failed to initialise:",e)}}playNotificationSound(){this.soundManager&&this.soundManager.playSound(this.settings.notificationSoundType,this.settings.muteNotificationSound)}testNotificationSound(){this.soundManager&&this.soundManager.playSound(this.settings.notificationSoundType,this.settings.muteNotificationSound),showNotification("Test sound played!","success")}addEntry(e){let t=e;if(!t){const e=document.getElementById("activity").value,n=document.getElementById("description").value,i=document.getElementById("timestamp").value;t={id:generateId(),activity:e,description:n,timestamp:new Date(i).toISOString(),created:(new Date).toISOString()}}this.entries.unshift(t),this.saveEntries(),this.displayEntries(),e||(document.getElementById("activityForm").reset(),this.setCurrentTime(),document.getElementById("activity").focus()),showNotification("Entry added successfully!","success")}updateEntry(){const e=document.getElementById("editId").value,t=document.getElementById("editActivity").value,n=document.getElementById("editDescription").value,i=document.getElementById("editTimestamp").value,a=this.entries.findIndex(t=>t.id===e);-1!==a&&(this.entries[a]={...this.entries[a],activity:t,description:n,timestamp:new Date(i).toISOString()},this.saveEntries(),this.displayEntries(),this.closeEditModal(),showNotification("Entry updated successfully!","success"))}deleteEntry(e){confirm("Are you sure you want to delete this entry?")&&(this.entries=this.entries.filter(t=>t.id!==e),this.saveEntries(),this.displayEntries(),showNotification("Entry deleted successfully!","success"))}editEntry(e){const t=this.entries.find(t=>t.id===e);t&&(document.getElementById("editId").value=t.id,document.getElementById("editActivity").value=t.activity,document.getElementById("editDescription").value=t.description||"",document.getElementById("editTimestamp").value=new Date(t.timestamp).toISOString().slice(0,16),document.getElementById("editModal").classList.add("active"))}closeEditModal(){document.getElementById("editModal").classList.remove("active")}displayEntries(){const e=document.getElementById("entriesList"),t=this.entries.slice(0,20);0!==t.length?e.innerHTML=t.map(e=>`\n            <div class="entry-item">\n                <div class="entry-content">\n                    <div class="entry-time">${formatDateTime(e.timestamp)}</div>\n                    <div class="entry-activity">${escapeHtml(e.activity)}</div>\n                    ${e.description?`<div class="entry-description">${this.renderDescriptionMarkdown(e.description)}</div>`:""}\n                </div>\n                <div class="entry-actions">\n                    <button class="btn btn-secondary" onclick="tracker.editEntry('${e.id}')">Edit</button>\n                    <button class="btn btn-danger" onclick="tracker.deleteEntry('${e.id}')">Delete</button>\n                </div>\n            </div>\n        `).join(""):e.innerHTML="<p>No entries yet. Add your first activity above!</p>"}renderDescriptionMarkdown(e){return this.markdownRenderer||void 0===MarkdownRenderer||this.initMarkdownRenderer(),this.markdownRenderer&&e?this.markdownRenderer.renderInlineWithClasses(e):escapeHtml(e)}saveEntries(){localStorage.setItem("activityEntries",JSON.stringify(this.entries))}saveSettings(){this.settings={...this.settings,notificationInterval:parseInt(document.getElementById("notificationInterval").value),startTime:document.getElementById("startTime").value,endTime:document.getElementById("endTime").value,pauseDuration:parseInt(document.getElementById("pauseDuration").value),muteNotificationSound:document.getElementById("muteNotificationSound").checked,notificationSoundType:document.getElementById("notificationSoundType").value,darkMode:document.getElementById("darkMode").checked,workingDays:{monday:document.getElementById("monday").checked,tuesday:document.getElementById("tuesday").checked,wednesday:document.getElementById("wednesday").checked,thursday:document.getElementById("thursday").checked,friday:document.getElementById("friday").checked,saturday:document.getElementById("saturday").checked,sunday:document.getElementById("sunday").checked}},localStorage.setItem("activitySettings",JSON.stringify(this.settings)),this.applyTheme(),this.startNotificationTimer(),showNotification("Settings saved successfully!","success")}loadSettings(){document.getElementById("notificationInterval").value=this.settings.notificationInterval,document.getElementById("startTime").value=this.settings.startTime,document.getElementById("endTime").value=this.settings.endTime,document.getElementById("pauseDuration").value=this.settings.pauseDuration,document.getElementById("muteNotificationSound").checked=this.settings.muteNotificationSound,document.getElementById("notificationSoundType").value=this.settings.notificationSoundType,document.getElementById("darkMode").checked=this.settings.darkMode,Object.entries(this.settings.workingDays).forEach(([e,t])=>{document.getElementById(e).checked=t}),this.applyTheme()}applyTheme(){this.settings.darkMode?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode")}async enableNotifications(){if(!("Notification"in window)||!("serviceWorker"in navigator))return alert("This browser does not support notifications or service workers."),void this.updateDebugInfo();if(this.settings.notificationsEnabled&&"granted"===Notification.permission)return this.settings.notificationsEnabled=!1,this.saveSettings(),this.stopNotificationTimer(),showNotification("Notifications disabled","success"),this.updateNotificationStatus(),void this.updateDebugInfo();try{const e=await Notification.requestPermission();"granted"===e?(this.settings.notificationsEnabled=!0,this.saveSettings(),showNotification("Notifications enabled successfully!","success"),this.startNotificationTimer(),setTimeout(()=>{this.testNotification(!0)},1e3)):showNotification("denied"===e?"Notifications were denied. Please check your browser settings and try again.":"Notification permission was not granted. Please try again.","error"),setTimeout(()=>{this.updateNotificationStatus(),this.updateDebugInfo()},500)}catch(e){console.error("Error requesting notification permission:",e),showNotification("Error requesting notification permission: "+e.message,"error"),this.updateDebugInfo()}}async showNotificationWithServiceWorker(e,t){if("Notification"in window)if("granted"===Notification.permission){try{if("serviceWorker"in navigator&&navigator.serviceWorker.controller){const n=await navigator.serviceWorker.ready;return void await n.showNotification(e,t)}}catch(e){console.warn("Service Worker notification failed, falling back to direct notification:",e)}try{const n={body:t.body,icon:t.icon,tag:t.tag,requireInteraction:t.requireInteraction},i=new Notification(e,n);i.onclick=()=>{window.focus(),i.close()},t.requireInteraction||setTimeout(()=>{i.close()},5e3)}catch(e){console.error("Both Service Worker and direct notification failed:",e),showNotification("Activity reminder: "+(t.body||"Time to log your activity!"),"info",8e3)}}else console.warn("Notification permission not granted");else console.warn("Notifications not supported")}testNotification(e=!1){if(this.updateDebugInfo(),this.playNotificationSound(),"granted"===Notification.permission)try{const t={body:"This is a test notification. If you can see this, notifications are working correctly!",icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23667eea"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',tag:"test-notification",requireInteraction:!1,actions:[{action:"reply",type:"text",title:"Log Activity",placeholder:"e.g. coding"}]};this.showNotificationWithServiceWorker("Activity Tracker Test",t),e||showNotification("Test notification sent successfully!","success")}catch(e){console.error("Error creating test notification:",e),showNotification("Error creating test notification: "+e.message,"error"),this.updateDebugInfo()}else e||showNotification("Please enable notifications first! Current permission: "+Notification.permission,"error")}refreshNotificationStatus(){this.updateNotificationStatus(),this.updateDebugInfo(),showNotification("Notification status refreshed","success")}updateNotificationStatus(){const e=document.getElementById("notificationStatus"),t=document.getElementById("statusIndicator"),n=document.getElementById("statusText"),i=document.querySelector('button[onclick="enableNotifications()"]');if("Notification"in window)switch(Notification.permission){case"granted":this.settings.notificationsEnabled?(e.className="notification-status notification-enabled",t.className="status-indicator status-active",n.textContent="Notifications are enabled and working",i&&(i.textContent="Disable Notifications")):(e.className="notification-status notification-warning",t.className="status-indicator status-inactive",n.textContent="Notifications are disabled by user",i&&(i.textContent="Enable Notifications"));break;case"denied":e.className="notification-status notification-disabled",t.className="status-indicator status-inactive",n.textContent="Notifications are blocked - please enable them in browser settings",i&&(i.textContent="Enable Notifications");break;default:e.className="notification-status notification-warning",t.className="status-indicator status-inactive",n.textContent='Notifications are disabled - click "Enable Notifications" to activate',i&&(i.textContent="Enable Notifications")}else e.className="notification-status notification-disabled",t.className="status-indicator status-inactive",n.textContent="Notifications not supported in this browser",i&&(i.textContent="Not Supported");"file:"===window.location.protocol&&(e.className="notification-status notification-warning",n.textContent+=" (Note: Running from local file may limit notification functionality)")}updateDebugInfo(){const e=document.getElementById("debugText"),t=[];t.push(`Version: ${APP_VERSION}`),t.push(""),t.push(`Browser: ${navigator.userAgent.split(" ").slice(-2).join(" ")}`),t.push(`Platform: ${navigator.platform||"Unknown"}`),t.push(`Protocol: ${window.location.protocol}`),t.push("Notification API: "+("Notification"in window?"Available":"Not Available")),"Notification"in window&&(t.push(`Permission: ${Notification.permission}`),t.push(`Max Actions: ${Notification.maxActions||"Unknown"}`)),"serviceWorker"in navigator?(t.push("Service Worker: Available"),navigator.serviceWorker.controller?(t.push(`SW State: ${navigator.serviceWorker.controller.state}`),t.push(`SW URL: ${navigator.serviceWorker.controller.scriptURL.split("/").pop()}`)):t.push("SW State: No controller"),navigator.serviceWorker.getRegistration().then(e=>{if(e){const t=document.getElementById("debugText");t&&t.innerHTML.includes("SW Scope: Checking...")&&(t.innerHTML=t.innerHTML.replace("SW Scope: Checking...",`SW Scope: ${e.scope}`))}}).catch(e=>{console.warn("SW registration check failed:",e)}),t.push("SW Scope: Checking...")):(t.push("Service Worker: Not Available"),"file:"===window.location.protocol&&t.push("SW Reason: file:// protocol (expected)")),t.push("Web Audio API: "+(this.audioContext?"Available":"Not Available")),t.push("Sound Muted: "+(this.settings.muteNotificationSound?"Yes":"No")),t.push(`Sound Type: ${this.settings.notificationSoundType}`),t.push(`Last Updated: ${(new Date).toLocaleTimeString("en-GB")}`),e.innerHTML=t.join("<br>")}async runServiceWorkerDiagnostics(){const e={available:"serviceWorker"in navigator,protocol:window.location.protocol,userAgent:navigator.userAgent,platform:navigator.platform,registration:null,controller:null,error:null};if(!e.available)return e.error="Service Worker API not available",e;try{if(e.registration=await navigator.serviceWorker.getRegistration(),e.controller=navigator.serviceWorker.controller,e.controller)try{const t=new MessageChannel,n=await new Promise((n,i)=>{const a=setTimeout(()=>i(new Error("SW communication timeout")),5e3);t.port1.onmessage=e=>{clearTimeout(a),n(e.data)},e.controller.postMessage({type:"GET_VERSION"},[t.port2])});e.communication="Working",e.swVersion=n.version}catch(t){e.communication=`Failed: ${t.message}`}}catch(t){e.error=t.message}return e}startNotificationTimer(){this.notificationTimer&&clearInterval(this.notificationTimer),this.notificationTimer=setInterval(()=>{this.checkForNotification()},6e4)}stopNotificationTimer(){this.notificationTimer&&(clearInterval(this.notificationTimer),this.notificationTimer=null)}checkForNotification(){if(!this.settings.notificationsEnabled)return;if(this.settings.notificationsPausedUntil){if((new Date).getTime()<this.settings.notificationsPausedUntil)return;this.unpauseNotifications(!1)}if("granted"!==Notification.permission)return;const e=new Date,t=60*e.getHours()+e.getMinutes(),n=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][e.getDay()];if(!this.settings.workingDays[n])return;const[i,a]=this.settings.startTime.split(":").map(Number),[r,o]=this.settings.endTime.split(":").map(Number);if(t<60*i+a||t>60*r+o)return;const s=localStorage.getItem("lastNotificationTime"),c=e.getTime()-(s||0),l=60*this.settings.notificationInterval*1e3;l>0&&c>=l&&(this.showActivityReminder(),localStorage.setItem("lastNotificationTime",e.getTime().toString()))}showActivityReminder(){this.playNotificationSound(),this.setCurrentTime();try{const e={body:"What are you working on right now?",icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23667eea"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',tag:"activity-reminder",requireInteraction:!0,actions:[{action:"reply",type:"text",title:"Log Activity",placeholder:"e.g. coding"}]};this.showNotificationWithServiceWorker("Activity Tracker Reminder",e)}catch(e){console.error("Error showing activity reminder:",e)}}setCurrentTime(){const e=document.getElementById("timestamp");e&&(e.value=getCurrentTimeForInput())}togglePause(e=!0){if(this.settings.notificationsPausedUntil)this.pauseManager?this.pauseManager.resume():this.unpauseNotifications(e);else if(this.pauseManager)this.pauseManager.startPause(this.settings.pauseDuration);else{const e=this.settings.pauseDuration;this.settings.notificationsPausedUntil=-1===e?1/0:(new Date).getTime()+60*e*1e3,this.updatePauseButtonState(),this.saveSettings()}e&&showNotification(this.settings.notificationsPausedUntil?"Notifications paused":"Notifications resumed",this.settings.notificationsPausedUntil?"info":"success")}unpauseNotifications(e=!0){this.settings.notificationsPausedUntil=null,e&&showNotification("Notifications resumed","success"),this.updatePauseButtonState(),this.saveSettings()}updatePauseButtonState(){this.pauseManager&&this.pauseManager.updatePauseButtonDisplay()}clearAllData(){confirm("Are you sure you want to clear all data? This cannot be undone.")&&(localStorage.removeItem("activityEntries"),localStorage.removeItem("activitySettings"),localStorage.removeItem("lastNotificationTime"),this.entries=[],this.currentReportEntries=[],this.displayEntries(),document.getElementById("reportPreview").innerHTML="",showNotification("All data cleared successfully!","success"))}exportDatabase(){try{const e={version:"1.0",timestamp:(new Date).toISOString(),entries:this.entries,settings:this.settings},t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(n),a=document.createElement("a");a.href=i,a.download=`activity-tracker-backup-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i),showNotification("Database exported successfully!","success")}catch(e){console.error("Error exporting database:",e),showNotification("Error exporting database: "+e.message,"error")}}importDatabase(e){try{const t=JSON.parse(e);if(!t.entries||!Array.isArray(t.entries))throw new Error("Invalid backup file: missing or invalid entries data");const n=t.entries.length,i=t.timestamp?new Date(t.timestamp).toLocaleDateString("en-GB"):"unknown date";if(!confirm(`Import ${n} entries from backup created on ${i}? This will replace all current data.`))return;const a=t.entries.filter(e=>e&&"object"==typeof e&&e.timestamp);a.length!==t.entries.length&&console.warn(`Filtered out ${t.entries.length-a.length} invalid entries`),this.entries=a,localStorage.setItem("activityEntries",JSON.stringify(this.entries)),t.settings&&"object"==typeof t.settings&&(this.settings={...this.settings,...t.settings},localStorage.setItem("activitySettings",JSON.stringify(this.settings)),this.loadSettings()),this.displayEntries(),this.currentReportEntries=[],document.getElementById("reportPreview").innerHTML="",showNotification(`Database imported successfully! Restored ${a.length} entries.`,"success")}catch(e){console.error("Error importing database:",e),showNotification("Error importing database: "+e.message,"error")}}initTemplatePreviewGrid(){}openTemplateManager(){this.templateManagerState={templates:{...this.getReportTemplates()},currentTemplateId:null,hasUnsavedChanges:!1,originalTemplates:{...this.getReportTemplates()}};const e=document.getElementById("templateManagerOverlay");e&&(e.classList.add("active"),this.populateTemplateList(),this.clearTemplateEditor())}closeTemplateManager(){if(this.templateManagerState&&this.templateManagerState.hasUnsavedChanges&&!confirm("You have unsaved changes. Are you sure you want to close without saving?"))return;const e=document.getElementById("templateManagerOverlay");e&&e.classList.remove("active"),this.templateManagerState=null}populateTemplateList(){const e=document.getElementById("templateList");if(!e||!this.templateManagerState)return;const t=this.templateManagerState.templates,n=this.settings.defaultTemplate||"detailed-html";e.innerHTML="",Object.keys(t).forEach(i=>{const a=t[i],r=i===n,o=i===this.templateManagerState.currentTemplateId,s=document.createElement("div");s.className=`template-list-item ${o?"active":""} ${r?"default":""}`,s.onclick=()=>this.selectTemplate(i),s.innerHTML=`\n                <div class="template-list-item-name">${a.name}</div>\n                <div class="template-list-item-desc">${a.description}</div>\n                <div class="template-list-item-type">${a.type}</div>\n            `,e.appendChild(s)})}selectTemplate(e){this.templateManagerState&&this.templateManagerState.hasUnsavedChanges&&!confirm("You have unsaved changes. Continue without saving?")||(this.templateManagerState.currentTemplateId=e,this.templateManagerState.hasUnsavedChanges=!1,this.populateTemplateList(),this.loadTemplateIntoEditor(e),this.refreshTemplatePreview())}loadTemplateIntoEditor(e){const t=this.templateManagerState.templates[e];if(!t)return;document.getElementById("templateEditorTitle").textContent=`Editing: ${t.name}`,document.getElementById("templateEditorActions").style.display="flex",document.getElementById("templateEditorTabs").style.display="flex",this.switchTemplateTab("editor"),document.getElementById("templateName").value=t.name,document.getElementById("templateDescription").value=t.description,document.getElementById("templateType").value=t.type,document.getElementById("templateContent").value=t.template;const n=this.settings.defaultTemplate||"detailed-html";document.getElementById("templateIsDefault").checked=e===n,["templateName","templateDescription","templateType","templateContent","templateIsDefault"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("input",()=>{this.templateManagerState.hasUnsavedChanges=!0})})}clearTemplateEditor(){document.getElementById("templateEditorTitle").textContent="Select a template to edit",document.getElementById("templateEditorActions").style.display="none",document.getElementById("templateEditorTabs").style.display="none",document.getElementById("templateEditorForm").style.display="none",document.getElementById("templatePreviewPanel").style.display="none",document.getElementById("templatePreviewContent").innerHTML='<p class="template-preview-placeholder">Select a template to see preview</p>'}addNewTemplate(){const e="custom-"+Date.now();this.templateManagerState.templates[e]={name:"New Template",description:"Custom template",type:"html",template:"# {{report.startDate}} - {{report.endDate}}\n\n{{#each entry = entries}}\n- {{entry.activity}}\n{{/each}}"},this.templateManagerState.hasUnsavedChanges=!0,this.populateTemplateList(),this.selectTemplate(e)}saveCurrentTemplate(){if(!this.templateManagerState||!this.templateManagerState.currentTemplateId)return;const e=this.templateManagerState.currentTemplateId,t=document.getElementById("templateName").value.trim(),n=document.getElementById("templateDescription").value.trim(),i=document.getElementById("templateType").value,a=document.getElementById("templateContent").value,r=document.getElementById("templateIsDefault").checked;t&&a?(this.templateManagerState.templates[e]={name:t,description:n,type:i,template:a},r?this.settings.defaultTemplate=e:this.settings.defaultTemplate===e&&(this.settings.defaultTemplate="detailed-html"),this.templateManagerState.hasUnsavedChanges=!1,this.populateTemplateList(),this.refreshTemplatePreview(),showNotification("Template saved","success")):showNotification("Template name and content are required","error")}deleteCurrentTemplate(){if(!this.templateManagerState||!this.templateManagerState.currentTemplateId)return;const e=this.templateManagerState.currentTemplateId,t=this.templateManagerState.templates[e];confirm(`Delete template "${t.name}"? This cannot be undone.`)&&(window.ReportTemplates&&window.ReportTemplates[e]?showNotification("Cannot delete default templates","error"):(delete this.templateManagerState.templates[e],this.settings.defaultTemplate===e&&(this.settings.defaultTemplate="detailed-html"),this.templateManagerState.hasUnsavedChanges=!0,this.templateManagerState.currentTemplateId=null,this.populateTemplateList(),this.clearTemplateEditor(),showNotification("Template deleted","success")))}duplicateCurrentTemplate(){if(!this.templateManagerState||!this.templateManagerState.currentTemplateId)return;const e=this.templateManagerState.currentTemplateId,t=this.templateManagerState.templates[e],n="custom-"+Date.now(),i={name:t.name+" (Copy)",description:t.description,type:t.type,template:t.template};this.templateManagerState.templates[n]=i,this.templateManagerState.hasUnsavedChanges=!0,this.populateTemplateList(),this.selectTemplate(n),showNotification("Template duplicated","success")}resetToDefaults(){confirm("Reset all templates to defaults? This will delete all custom templates.")&&(this.templateManagerState.templates={...window.ReportTemplates},this.settings.defaultTemplate="detailed-html",this.templateManagerState.hasUnsavedChanges=!0,this.templateManagerState.currentTemplateId=null,this.populateTemplateList(),this.clearTemplateEditor(),showNotification("Templates reset to defaults","success"))}generateTestData(){const e=new Date,t=new Date(e.getTime()-6048e5),n=e,i=new Date(t),a=new Date(t.getTime()+864e5),r=new Date(t.getTime()+1728e5),o=[{id:"1",timestamp:i.toISOString(),activity:"Planning project roadmap",description:"Defined key milestones and deliverables for Q3",duration:45,endTime:new Date(i.getTime()+27e5).toISOString()},{id:"2",timestamp:new Date(i.getTime()+72e5).toISOString(),activity:"Team standup meeting",description:"Discussed progress and blocked items",duration:30,endTime:new Date(i.getTime()+72e5+18e5).toISOString()}],s=[{id:"3",timestamp:a.toISOString(),activity:"Code review",description:"Reviewed pull requests for **authentication module**",duration:60,endTime:new Date(a.getTime()+36e5).toISOString()}],c=[{id:"4",timestamp:r.toISOString(),activity:"Documentation update",description:"Updated API documentation with new endpoints",duration:90,endTime:new Date(r.getTime()+54e5).toISOString()}],l=[...o,...s,...c],d=l.reduce((e,t)=>e+t.duration,0);return{report:{startDate:t.toISOString(),endDate:n.toISOString(),totalEntries:l.length,totalDuration:d,activeDays:3},entries:l,days:[{date:i.toDateString(),entries:o,totalDuration:o.reduce((e,t)=>e+t.duration,0)},{date:a.toDateString(),entries:s,totalDuration:s.reduce((e,t)=>e+t.duration,0)},{date:r.toDateString(),entries:c,totalDuration:c.reduce((e,t)=>e+t.duration,0)}]}}refreshTemplatePreview(){if(!this.templateManagerState||!this.templateManagerState.currentTemplateId)return;const e=this.templateManagerState.currentTemplateId,t=this.templateManagerState.templates[e],n=document.getElementById("templatePreviewContent");if(!t||!n)return;const i=document.getElementById("templateContent"),a={...t,template:i?i.value:t.template},r=document.getElementById("previewTabRendered"),o=r&&r.classList.contains("active");try{const e=this.generateTestData();this.templatingEngine||(this.templatingEngine=new TemplatingEngine);const t=this.templatingEngine.render(a.template,e);if(o){if("html"===a.type){const e=document.createElement("iframe");return e.style.width="100%",e.style.height="400px",e.style.border="none",e.style.borderRadius="4px",n.innerHTML="",n.appendChild(e),e.contentDocument.open(),e.contentDocument.write(t),void e.contentDocument.close()}if("markdown"===a.type&&this.markdownRenderer){const e=this.markdownRenderer.render(t);return void(n.innerHTML=`<div class="markdown-preview">${e}</div>`)}n.innerHTML=`<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px;">${this.escapeHtml(t)}</pre>`}else n.innerHTML=`<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px;">${this.escapeHtml(t)}</pre>`}catch(e){n.innerHTML=`<div style="color: #e53e3e; padding: 20px; text-align: center;">\n                <strong>Error generating preview:</strong><br>\n                <code style="background: #fed7d7; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top: 8px;">${e.message}</code>\n            </div>`}}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}switchPreviewTab(e){document.getElementById("previewTabRendered").classList.toggle("active","rendered"===e),document.getElementById("previewTabSource").classList.toggle("active","source"===e),this.refreshTemplatePreview()}switchReportPreviewTab(e){document.getElementById("reportPreviewTabRendered").classList.toggle("active","rendered"===e),document.getElementById("reportPreviewTabSource").classList.toggle("active","source"===e),this.previewReport()}switchTemplateTab(e){document.getElementById("tabEditor").classList.toggle("active","editor"===e),document.getElementById("tabPreview").classList.toggle("active","preview"===e),document.getElementById("templateEditorForm").style.display="editor"===e?"flex":"none",document.getElementById("templatePreviewPanel").style.display="preview"===e?"flex":"none","preview"===e&&this.refreshTemplatePreview()}saveAllTemplates(){if(!this.templateManagerState)return;this.templateManagerState.currentTemplateId&&this.saveCurrentTemplate();const e={};Object.keys(this.templateManagerState.templates).forEach(t=>{window.ReportTemplates&&window.ReportTemplates[t]||(e[t]=this.templateManagerState.templates[t])}),localStorage.setItem("customReportTemplates",JSON.stringify(e)),localStorage.setItem("activitySettings",JSON.stringify(this.settings)),this.initTemplatePreviewGrid();const t=document.getElementById("reportTemplate");if(t){const e=t.value;t.innerHTML="",Object.keys(this.templateManagerState.templates).forEach(e=>{const n=this.templateManagerState.templates[e],i=document.createElement("option");i.value=e,i.textContent=n.name,t.appendChild(i)}),t.value=e||this.settings.defaultTemplate||"detailed-html"}this.closeTemplateManager(),showNotification("All templates saved successfully!","success")}}function getWeekStart(e){const t=(e=new Date(e)).getDay(),n=e.getDate()-t+(0===t?-6:1);return new Date(e.setDate(n))}function getWeekEnd(e){const t=getWeekStart(e),n=new Date(t);return n.setDate(t.getDate()+6),n}let tracker,deferredPrompt;function showSection(e,t){if(document.querySelectorAll(".section").forEach(e=>{e.classList.remove("active")}),document.getElementById(e).classList.add("active"),document.querySelectorAll(".nav-btn").forEach(e=>{e.classList.remove("active")}),t&&t.target)t.target.classList.add("active");else{const t=document.querySelector(`.nav-btn[onclick*="'${e}'"]`);t&&t.classList.add("active")}if("tracker"===e&&setTimeout(()=>{const e=document.getElementById("activity");e&&e.focus()},100),"reports"===e){const e=document.getElementById("reportResults");!tracker||e&&e.innerHTML.trim()||tracker.setWeeklyReport()}}function addCurrentTime(){tracker&&tracker.setCurrentTime()}function generateReport(){tracker&&tracker.generateReport()}function setWeeklyReport(){tracker&&tracker.setWeeklyReport()}function previousWeek(){tracker&&tracker.previousWeek()}function nextWeek(){tracker&&tracker.nextWeek()}function downloadReport(){tracker&&tracker.downloadReport()}function saveSettings(){tracker&&tracker.saveSettings()}function enableNotifications(){tracker&&tracker.enableNotifications()}function testNotification(){tracker&&tracker.testNotification()}function testNotificationSound(){tracker&&tracker.testNotificationSound()}function refreshNotificationStatus(){tracker&&tracker.refreshNotificationStatus()}function clearAllData(){tracker&&tracker.clearAllData()}function closeEditModal(){tracker&&tracker.closeEditModal()}function togglePause(){tracker&&tracker.togglePause()}function saveReportTemplates(){tracker&&tracker.saveReportTemplates()}function resetReportTemplates(){tracker&&tracker.resetReportTemplates()}function exportDatabase(){tracker&&tracker.exportDatabase()}function importDatabase(){const e=document.getElementById("importFile");e&&e.click()}function handleImportFile(e){const t=e.target.files[0];if(!t)return;if("application/json"!==t.type&&!t.name.endsWith(".json"))return void showNotification("Please select a valid JSON backup file.","error");const n=new FileReader;n.onload=function(t){tracker&&tracker.importDatabase(t.target.result),e.target.value=""},n.onerror=function(){showNotification("Error reading backup file.","error"),e.target.value=""},n.readAsText(t)}function openTemplateManager(){tracker&&tracker.openTemplateManager()}function closeTemplateManager(){tracker&&tracker.closeTemplateManager()}function addNewTemplate(){tracker&&tracker.addNewTemplate()}function resetToDefaults(){tracker&&tracker.resetToDefaults()}function saveCurrentTemplate(){tracker&&tracker.saveCurrentTemplate()}function deleteCurrentTemplate(){tracker&&tracker.deleteCurrentTemplate()}function duplicateCurrentTemplate(){tracker&&tracker.duplicateCurrentTemplate()}function refreshTemplatePreview(){tracker&&tracker.refreshTemplatePreview()}function saveAllTemplates(){tracker&&tracker.saveAllTemplates()}function switchPreviewTab(e){tracker&&tracker.switchPreviewTab(e)}function switchReportPreviewTab(e){tracker&&tracker.switchReportPreviewTab(e)}function switchTemplateTab(e){tracker&&tracker.switchTemplateTab(e)}async function runServiceWorkerTest(){if(tracker){showNotification("Running Service Worker diagnostics...","info");try{const e=await tracker.runServiceWorkerDiagnostics();let t="Service Worker Diagnostics:\n\n";t+=`Available: ${e.available}\n`,t+=`Protocol: ${e.protocol}\n`,t+=`Platform: ${e.platform}\n`,e.registration?(t+="Registration: Active\n",t+=`Scope: ${e.registration.scope}\n`):t+="Registration: None\n",e.controller?t+=`Controller: Active (${e.controller.state})\n`:t+="Controller: None\n",e.communication&&(t+=`Communication: ${e.communication}\n`),e.swVersion&&(t+=`SW Version: ${e.swVersion}\n`),e.error&&(t+=`Error: ${e.error}\n`),alert(t);const n=e.available&&e.registration?"success":"warning";showNotification(e.available&&e.registration?"Service Worker is working correctly":"Service Worker issues detected (see console)",n)}catch(e){console.error("Diagnostic test failed:",e),showNotification("Diagnostic test failed: "+e.message,"error")}}else showNotification("Tracker not initialized","error")}Object.assign(ActivityTracker.prototype,{initReportTemplates(){this.templatingEngine=new TemplatingEngine;const e=document.getElementById("reportTemplate");if(!e)return;const t=this.getReportTemplates();e.innerHTML=Object.keys(t).map(e=>`<option value="${e}">${t[e].name}</option>`).join("")},prepareReportData(e,t,n){const i=[...e].sort((e,t)=>new Date(e.timestamp)-new Date(t.timestamp)),a=i.map((e,t)=>{e.timestamp||console.error("Entry missing timestamp:",e);const n=i[t+1];let a,r;if(n)a=new Date(n.timestamp),r=Math.round((a-new Date(e.timestamp))/6e4);else{const t=new Date(e.timestamp),[n,i]=this.settings.endTime.split(":").map(Number);t.setHours(n,i,0,0),a=new Date(Math.min(new Date,t)),r=Math.round((a-new Date(e.timestamp))/6e4)}return{...e,endTime:a,duration:r}}),r={};a.forEach(e=>{const t=new Date(e.timestamp).toLocaleDateString("en-GB",{weekday:"long",year:"numeric",month:"long",day:"numeric"});r[t]||(r[t]={entries:[],totalDuration:0}),r[t].entries.push(e),r[t].totalDuration+=e.duration>0?e.duration:0});const o=Object.keys(r).map(e=>({date:e,entries:r[e].entries,totalDuration:r[e].totalDuration})),s=o.reduce((e,t)=>e+t.totalDuration,0);return{report:{startDate:t,endDate:n,generatedDate:new Date,totalEntries:a.length,totalDuration:s,activeDays:o.length},days:o,entries:a}},renderReport(e,t){return this.templatingEngine.render(e,t)},generateReport(){const e=document.getElementById("reportStartDate").value,t=document.getElementById("reportEndDate").value;if(!e||!t)return void showNotification("Please select both start and end dates","error");const n=new Date(e),i=new Date(t);i.setHours(23,59,59,999);const a=this.entries.filter(e=>{const t=new Date(e.timestamp);return t>=n&&t<=i});this.currentReportEntries=a,this.currentReportData=this.prepareReportData(a,n,i),this.previewReport()},previewReport(){const e=document.getElementById("reportPreview");if(!e)return;if(!this.currentReportData||0===this.currentReportEntries.length)return void(e.innerHTML="No data for the selected period. Generate a report first.");const t=document.getElementById("reportTemplate").value,n=this.getReportTemplates()[t];if(!n)return void(e.textContent="Error: Selected report template not found.");const i=document.getElementById("reportPreviewTabRendered"),a=i&&i.classList.contains("active");try{const t=this.renderReport(n.template,this.currentReportData);if(a)if("html"===n.type)e.innerHTML=`<iframe srcdoc="${this.templatingEngine.escapeHtml(t)}" style="width: 100%; height: 450px; border: none;"></iframe>`;else if("markdown"===n.type&&this.markdownRenderer){const n=this.markdownRenderer.render(t);e.innerHTML=n}else e.innerHTML=`<pre>${this.templatingEngine.escapeHtml(t)}</pre>`;else e.innerHTML=`<pre>${this.templatingEngine.escapeHtml(t)}</pre>`}catch(t){e.textContent="Error generating preview: "+t.message}},downloadReport(){if(!this.currentReportData||0===this.currentReportEntries.length)return void showNotification("Please generate a report with data first","error");const e=document.getElementById("reportTemplate").value,t=this.getReportTemplates()[e],n=this.currentReportData.report.startDate,i=this.currentReportData.report.endDate,a=this.renderReport(t.template,this.currentReportData),r=t.type,o={html:"text/html",markdown:"text/markdown",csv:"text/csv"}[r]||"text/plain";downloadFile(a,`activity-report-${this.templatingEngine.formatDate(n,"yyyy-mm-dd")}-to-${this.templatingEngine.formatDate(i,"yyyy-mm-dd")}.${r}`,o),showNotification(`Report downloaded as ${t.name}`,"success")},setWeeklyReport(){const e=new Date;this.currentWeekStart=getWeekStart(e),this.updateWeekFromCurrent(),this.generateReport()},previousWeek(){this.currentWeekStart||(this.currentWeekStart=getWeekStart(new Date)),this.currentWeekStart.setDate(this.currentWeekStart.getDate()-7),this.updateWeekFromCurrent(),this.generateReport()},nextWeek(){this.currentWeekStart||(this.currentWeekStart=getWeekStart(new Date)),this.currentWeekStart.setDate(this.currentWeekStart.getDate()+7),this.updateWeekFromCurrent(),this.generateReport()},updateWeekFromCurrent(){const e=new Date(this.currentWeekStart),t=getWeekEnd(e);document.getElementById("reportStartDate").value=e.toISOString().split("T")[0],document.getElementById("reportEndDate").value=t.toISOString().split("T")[0],this.updateWeekDisplay()},updateWeekDisplay(){if(!this.currentWeekStart)return;const e=new Date(this.currentWeekStart),t=getWeekEnd(e),n=`Week of ${e.toLocaleDateString("en-GB",{day:"numeric",month:"short"})} - ${t.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}`;document.getElementById("weekDisplay").textContent=n}}),document.addEventListener("DOMContentLoaded",()=>{tracker=new ActivityTracker,"serviceWorker"in navigator&&("file:"===window.location.protocol||navigator.serviceWorker.register("./sw.js").then(e=>{e.addEventListener("updatefound",()=>{const t=e.installing;t&&t.addEventListener("statechange",()=>{"installed"===t.state&&navigator.serviceWorker.controller&&showNotification("App updated! Refresh for latest version.","info",1e4)})}),tracker&&tracker.updateDebugInfo()}).catch(e=>{console.error("❌ Service Worker registration failed:",e),navigator.platform.includes("Mac")&&"SecurityError"===e.name&&(console.warn("🍎 macOS Security Error: This may be due to strict security settings"),console.warn("💡 Try serving over HTTP/HTTPS instead of file://")),tracker&&tracker.updateDebugInfo()}),navigator.serviceWorker.addEventListener("message",e=>{e.data&&"add-entry"===e.data.type&&tracker&&(tracker.addEntry(e.data.entry),showNotification("Activity logged from notification!","success")),e.data&&"navigate-to-tracker"===e.data.type&&showSection("tracker")}),navigator.serviceWorker.addEventListener("controllerchange",()=>{tracker&&tracker.updateDebugInfo()})),"#tracker"===window.location.hash&&(showSection("tracker"),history.replaceState(null,document.title,window.location.pathname+window.location.search))}),document.addEventListener("click",e=>{e.target.classList.contains("modal")&&closeEditModal()}),document.addEventListener("keydown",e=>{if("Escape"===e.key&&closeEditModal(),(e.ctrlKey||e.metaKey)&&"Enter"===e.key){const e=document.activeElement;if(e&&("activity"===e.id||"description"===e.id)){const e=document.getElementById("activityForm");e&&e.dispatchEvent(new Event("submit"))}}}),document.addEventListener("visibilitychange",()=>{tracker&&(document.hidden||tracker.updateDebugInfo())}),window.addEventListener("online",()=>{showNotification("Connection restored","success")}),window.addEventListener("offline",()=>{showNotification("Working offline","info")}),window.addEventListener("beforeunload",e=>{tracker&&tracker.pauseManager&&tracker.pauseManager.destroy();const t=document.getElementById("activity");if(t&&t.value.trim())return e.preventDefault(),e.returnValue="You have unsaved activity data. Are you sure you want to leave?",e.returnValue}),window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),deferredPrompt=e,showNotification("This app can be installed on your device!","info")}),window.addEventListener("appinstalled",()=>{showNotification("Activity Tracker installed successfully!","success"),deferredPrompt=null}),window.addEventListener("error",e=>{console.error("❌ Uncaught error:",e.error),showNotification("An unexpected error occurred. Please refresh the page.","error")}),window.addEventListener("unhandledrejection",e=>{console.error("❌ Unhandled promise rejection:",e.reason),showNotification("An unexpected error occurred. Please refresh the page.","error")}),window.addEventListener("load",()=>{if(window.performance&&window.performance.timing){const e=window.performance.timing;e.loadEventEnd,e.navigationStart}}),"undefined"!=typeof module&&module.exports&&(module.exports={showSection:showSection,addCurrentTime:addCurrentTime,generateReport:generateReport,setWeeklyReport:setWeeklyReport,previousWeek:previousWeek,nextWeek:nextWeek,downloadReport:downloadReport,saveSettings:saveSettings,enableNotifications:enableNotifications,testNotification:testNotification,testNotificationSound:testNotificationSound,refreshNotificationStatus:refreshNotificationStatus,clearAllData:clearAllData,closeEditModal:closeEditModal,togglePause:togglePause,exportDatabase:exportDatabase,importDatabase:importDatabase,handleImportFile:handleImportFile,runServiceWorkerTest:runServiceWorkerTest});</script></body></html>